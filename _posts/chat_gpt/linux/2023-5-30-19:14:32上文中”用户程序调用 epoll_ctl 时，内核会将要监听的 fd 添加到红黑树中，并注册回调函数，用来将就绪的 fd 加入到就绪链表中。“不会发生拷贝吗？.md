---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).Analyze the following content and express your opinion,or give your answer:
"poll/select å…ˆå°†è¦ç›‘å¬çš„ fd ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´, ç„¶ååœ¨å†…æ ¸ç©ºé—´é‡Œé¢è¿›è¡Œå¤„ç†ä¹‹åï¼Œå†æ‹·è´ç»™ç”¨æˆ·ç©ºé—´ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°å†…æ ¸ç©ºé—´ç”³è¯·å†…å­˜ï¼Œé‡Šæ”¾å†…å­˜ç­‰ç­‰è¿‡ç¨‹ï¼Œè¿™åœ¨å¤§é‡ fd æƒ…å†µä¸‹ï¼Œæ˜¯éå¸¸è€—æ—¶çš„ã€‚è€Œ epoll ç»´æŠ¤äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œé€šè¿‡å¯¹è¿™æ£µé»‘çº¢æ ‘è¿›è¡Œæ“ä½œï¼Œå¯ä»¥é¿å…å¤§é‡çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„æ“ä½œï¼Œè€Œä¸”æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ã€‚"

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰å›å¤æ‚¨ã€‚ğŸ˜Š

æ‚¨çš„å†…å®¹æ˜¯å…³äºä¸‰ç§ä¸åŒçš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼šselectï¼Œpoll å’Œ epollã€‚è¿™äº›æŠ€æœ¯éƒ½å¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ï¼Œå¹¶åœ¨å…¶ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥è¿›ç¨‹ã€‚<sup>1</sup> <sup>2</sup>

æ ¹æ®æ‚¨çš„å†…å®¹ï¼Œselect å’Œ poll çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¦å°†è¦ç›‘å¬çš„ fd ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶ååœ¨å†…æ ¸ç©ºé—´é‡Œé¢è¿›è¡Œå¤„ç†ä¹‹åï¼Œå†æ‹·è´ç»™ç”¨æˆ·ç©ºé—´ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°å†…æ ¸ç©ºé—´ç”³è¯·å†…å­˜ï¼Œé‡Šæ”¾å†…å­˜ç­‰ç­‰è¿‡ç¨‹ï¼Œè¿™åœ¨å¤§é‡ fd æƒ…å†µä¸‹ï¼Œæ˜¯éå¸¸è€—æ—¶çš„ã€‚<sup>3</sup> <sup>5</sup>

è€Œ epoll çš„ä¼˜ç‚¹æ˜¯å®ƒç»´æŠ¤äº†ä¸€ä¸ªçº¢é»‘æ ‘ï¼Œé€šè¿‡å¯¹è¿™æ£µé»‘çº¢æ ‘è¿›è¡Œæ“ä½œï¼Œå¯ä»¥é¿å…å¤§é‡çš„å†…å­˜ç”³è¯·å’Œé‡Šæ”¾çš„æ“ä½œï¼Œè€Œä¸”æŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ã€‚<sup>3</sup> <sup>5</sup> å¦å¤–ï¼Œepoll è¿˜æ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹æ²¿è§¦å‘ä¸¤ç§æ¨¡å¼ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å¼ã€‚<sup>4</sup> <sup>5</sup>

æˆ‘çš„è§‚ç‚¹æ˜¯ epoll æ˜¯ä¸€ç§æ¯” select å’Œ poll æ›´é«˜æ•ˆå’Œçµæ´»çš„ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ƒå¯ä»¥åœ¨é«˜å¹¶å‘å’Œå¤§è§„æ¨¡ç½‘ç»œåº”ç”¨ä¸­æä¾›æ›´å¥½çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚

\-
\[1]: [select v.s. poll v.s. epoll - Hechao's Blog](https://hechao.li/2022/01/04/select-vs-poll-vs-epoll/)
\[2]: [select / poll / epoll: practical difference for system architects](https://www.ulduzsoft.com/2014/01/select-poll-epoll-practical-difference-for-system-architects/)
\[3]: [Why is epoll faster than select? - Stack Overflow](https://stackoverflow.com/questions/17355593/why-is-epoll-faster-than-select)
\[4]: [ä¸€æ–‡ææ‡‚selectã€pollå’ŒepollåŒºåˆ« - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/272891398)
\[5]: [select â€” Waiting for I/O completion â€” Python 3.11.3 documentation](https://docs.python.org/3/library/select.html)

<hr/>

Question:

select å’Œ poll çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¦å°†è¦ç›‘å¬çš„ fd ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

Answer:

è¿™æ˜¯å› ä¸º select å’Œ poll çš„æœºåˆ¶æ˜¯è¿™æ ·çš„ï¼š<sup>2</sup> <sup>6</sup>

- ç”¨æˆ·ç¨‹åºè°ƒç”¨ select æˆ– poll æ—¶ï¼Œè¦ä¼ å…¥ä¸€ä¸ª fd é›†åˆï¼Œè¿™ä¸ªé›†åˆæ˜¯åœ¨ç”¨æˆ·ç©ºé—´çš„å†…å­˜ä¸­çš„ã€‚
- å†…æ ¸æ¥æ”¶åˆ°è¿™ä¸ªè°ƒç”¨åï¼Œè¦å°†è¿™ä¸ª fd é›†åˆä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åéå†è¿™ä¸ªé›†åˆï¼Œæ£€æŸ¥æ¯ä¸ª fd çš„çŠ¶æ€ï¼Œçœ‹æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚
- å¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå†…æ ¸å°±è¦å°†è¿™äº›äº‹ä»¶çš„ä¿¡æ¯ä»å†…æ ¸ç©ºé—´æ‹·è´å›ç”¨æˆ·ç©ºé—´ï¼Œè®©ç”¨æˆ·ç¨‹åºçŸ¥é“å“ªäº› fd å¯ä»¥è¿›è¡Œ I/O æ“ä½œäº†ã€‚

æ‰€ä»¥ï¼Œselect å’Œ poll æ¯æ¬¡è°ƒç”¨éƒ½è¦è¿›è¡Œä¸¤æ¬¡ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´ï¼Œè¿™ä¼šå¢åŠ ç³»ç»Ÿçš„å¼€é”€å’Œå»¶è¿Ÿã€‚<sup>2</sup> <sup>6</sup>
\-
\[1]: [The Linux kernel: Handling of asynchronous events](https://www.win.tue.nl/~aeb/linux/lk/lk-12.html)
\[2]: [Buffer Sharing and Synchronization (dma-buf) - Kernel](https://docs.kernel.org/driver-api/dma-buf.html)
\[3]: [c - copy data from kernel space to user space - Stack Overflow](https://stackoverflow.com/questions/34159622/copy-data-from-kernel-space-to-user-space)
\[4]: [linux kernel - Polling control register of a device in user space to ...](https://stackoverflow.com/questions/19550272/polling-control-register-of-a-device-in-user-space-to-check-errors)
\[5]: [Poll/select copying to kernelspace from userspace](https://stackoverflow.com/questions/39272533/poll-select-copying-to-kernelspace-from-userspace)
\[6]: [select - Implementing poll in a Linux kernel module - Stack Overflow](https://stackoverflow.com/questions/34027366/implementing-poll-in-a-linux-kernel-module)

<hr/>

Question:

epoll æ‹·è´äº†å‡ æ¬¡è¦ç›‘å¬çš„ fdï¼Ÿ

Answer:

epoll çš„æœºåˆ¶æ˜¯è¿™æ ·çš„ï¼š<sup>1</sup> <sup>2</sup>

- ç”¨æˆ·ç¨‹åºè°ƒç”¨ epoll_create æ—¶ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ªçº¢é»‘æ ‘å’Œä¸€ä¸ªå°±ç»ªé“¾è¡¨ï¼Œç”¨æ¥å­˜å‚¨è¦ç›‘å¬çš„ fd å’Œå°±ç»ªçš„ fdã€‚
- ç”¨æˆ·ç¨‹åºè°ƒç”¨ epoll_ctl æ—¶ï¼Œå†…æ ¸ä¼šå°†è¦ç›‘å¬çš„ fd æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­ï¼Œå¹¶æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨æ¥å°†å°±ç»ªçš„ fd åŠ å…¥åˆ°å°±ç»ªé“¾è¡¨ä¸­ã€‚
- ç”¨æˆ·ç¨‹åºè°ƒç”¨ epoll_wait æ—¶ï¼Œå†…æ ¸ä¼šæ£€æŸ¥å°±ç»ªé“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œå°±é˜»å¡ç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼›å¦‚æœä¸ä¸ºç©ºï¼Œå°±å°†å°±ç»ªé“¾è¡¨ä¸­çš„ fd æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°ç»„ä¸­ï¼Œå¹¶è¿”å›ã€‚

æ‰€ä»¥ï¼Œepoll åªéœ€è¦åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰æ‹·è´ fdï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½æ‹·è´ã€‚è¿™æ ·å¯ä»¥å‡å°‘æ•°æ®æ‹·è´çš„æ¬¡æ•°å’Œå¼€é”€ã€‚<sup>1</sup> <sup>2</sup>

\-
\[1]: [How epoll works efficiently - SoByte](https://www.sobyte.net/post/2022-04/epoll-efficiently/)
\[2]: [GitHub - RajivKurian/epoll-example: A sample epoll server.](https://github.com/RajivKurian/epoll-example)
\[3]: [events - same fd in multiple epoll instances for seperate writing and ...](https://superuser.com/questions/1764767/same-fd-in-multiple-epoll-instances-for-seperate-writing-and-reading-threads)
\[4]: [c - Using sendfile() on fd returned by epoll - Stack Overflow](https://stackoverflow.com/questions/56900408/using-sendfile-on-fd-returned-by-epoll)

<hr/>

Question:

ä¸Šæ–‡ä¸­â€ç”¨æˆ·ç¨‹åºè°ƒç”¨ epoll_ctl æ—¶ï¼Œå†…æ ¸ä¼šå°†è¦ç›‘å¬çš„ fd æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­ï¼Œå¹¶æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨æ¥å°†å°±ç»ªçš„ fd åŠ å…¥åˆ°å°±ç»ªé“¾è¡¨ä¸­ã€‚â€œä¸ä¼šå‘ç”Ÿæ‹·è´å—ï¼Ÿ

Answer:

epoll_ctl ä¸ä¼šæ‹·è´ fdï¼Œå®ƒåªæ˜¯å°† fd æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­ï¼Œå¹¶æ³¨å†Œå›è°ƒå‡½æ•°ã€‚<sup>1</sup> <sup>2</sup> ä½ å¯ä»¥åœ¨ event.data ä¸­å­˜å‚¨ä»»ä½•ä½ æƒ³è¦çš„æ•°æ®ï¼Œç³»ç»Ÿä¼šå¿½ç•¥å®ƒï¼Œåªæ˜¯åœ¨ epoll_wait è¿”å›æ—¶å°†å®ƒè¿”å›ç»™ä½ ã€‚<sup>1</sup> è¿™æ ·ä½ å¯ä»¥æ–¹ä¾¿åœ°å…³è” fd å’Œå…¶ä»–ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦é¢å¤–çš„æ‹·è´æˆ–æŸ¥æ‰¾ã€‚<sup>1</sup>

\-
\[1]: [c - about epoll_ctl() - Stack Overflow](https://stackoverflow.com/questions/9325748/about-epoll-ctl)
\[2]: [Implementation of Epoll fd3kyt's blog - GitHub Pages](https://fd3kyt.github.io/posts/implementation-of-epoll/)
\[3]: [epoll_ctl(2) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man2/epoll_ctl.2.html)
\[4]: [How epoll works efficiently - SoByte](https://www.sobyte.net/post/2022-04/epoll-efficiently/)

<hr/>

