---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).
The following is a search input in a search engine, giving useful content or solutions and as much information as you can related to it, use markdown syntax to make your answer more readable, such as code blocks, bold, list:
```
case EPOLL_CTL_ADD:
    if (!epi) {
        epds.events |= POLLERR | POLLHUP;
        error = ep_insert(ep, &epds, tf.file, fd, full_check);
    } else
        error = -EEXIST;
    if (full_check)
        clear_tfile_check_list();
    break;
```

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æ‚¨çš„æœç´¢è¾“å…¥æ˜¯ä¸€ä¸ªLinuxç³»ç»Ÿè°ƒç”¨epoll_ctlçš„ä»£ç ç‰‡æ®µï¼Œå…¶ä¸­opå‚æ•°çš„å€¼æ˜¯EPOLL_CTL_ADDã€‚æ ¹æ®æœç´¢ç»“æœ<sup>1</sup> <sup>2</sup>ï¼Œè¿™ä¸ªå€¼çš„å«ä¹‰æ˜¯ï¼š

- å°†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdæ·»åŠ åˆ°epollæ–‡ä»¶æè¿°ç¬¦epfdçš„å…´è¶£åˆ—è¡¨ä¸­ï¼Œå¹¶å°†eventå‚æ•°æŒ‡å®šçš„è®¾ç½®ä¸fdå…³è”ã€‚
- å¦‚æœfdå·²ç»åœ¨epollæ–‡ä»¶æè¿°ç¬¦epfdçš„å…´è¶£åˆ—è¡¨ä¸­ï¼Œåˆ™è¿”å›é”™è¯¯ç -EEXIST<sup>1</sup>ã€‚
- å¦‚æœfdæ˜¯ä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™ä¸èƒ½æ·»åŠ åˆ°å¦ä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦epfdçš„å…´è¶£åˆ—è¡¨ä¸­ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯ç EINVAL<sup>3</sup>ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»£ç å—ã€ç²—ä½“ã€åˆ—è¡¨ç­‰markdownè¯­æ³•æ¥ä½¿æ‚¨çš„ç­”æ¡ˆæ›´æ˜“è¯»ã€‚ä¾‹å¦‚ï¼š

```c
// æ·»åŠ ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åˆ°epollå®ä¾‹
int epfd = epoll_create(1); // åˆ›å»ºä¸€ä¸ªepollæ–‡ä»¶æè¿°ç¬¦
int fd = open("somefile", O_RDONLY); // æ‰“å¼€ä¸€ä¸ªæ™®é€šæ–‡ä»¶
struct epoll_event event; // å®šä¹‰ä¸€ä¸ªepolläº‹ä»¶ç»“æ„ä½“
event.events = EPOLLIN; // è®¾ç½®æ„Ÿå…´è¶£çš„äº‹ä»¶ä¸ºå¯è¯»
event.data.fd = fd; // è®¾ç½®å…³è”çš„æ–‡ä»¶æè¿°ç¬¦ä¸ºfd
int res = epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &event); // è°ƒç”¨epoll_ctlå‡½æ•°
if (res == -1) {
    perror("epoll_ctl"); // å¦‚æœå‡ºé”™ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯
}
```

æ‚¨è¿˜æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼ŸğŸ˜Š

\-
\[1]: [epoll_ctl(2) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man2/epoll_ctl.2.html)
\[2]: [epoll_ctl(2) - Linux man page](https://linux.die.net/man/2/epoll_ctl)
\[3]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)

<hr/>

