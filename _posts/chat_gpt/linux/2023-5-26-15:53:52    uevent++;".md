---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).Explain the following code:
"//è¿™é‡Œå¯¹ä¸€ä¸ªfdå†æ¬¡è¿›è¡Œpollæ“ä½œï¼Œä»¥ç¡®è®¤äº‹ä»¶
revents = ep_item_poll(epi, &pt);
/*
 * If the event mask intersect the caller-requested one,
 * deliver the event to userspace. Again, ep_scan_ready_list()
 * is holding "mtx", so no operations coming from userspace
 * can change the item.
 */
if (revents) {
    if (__put_user(revents, &uevent->events) ||
        __put_user(epi->event.data, &uevent->data)) {
        list_add(&epi->rdllink, head);
        ep_pm_stay_awake(epi);
        return eventcnt ? eventcnt : -EFAULT;
    }
    eventcnt++;
    uevent++;"

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰å›å¤æ‚¨ã€‚ğŸ˜Š

è¿™æ®µä»£ç æ˜¯ä½¿ç”¨epollï¼ˆLinuxå†…æ ¸çš„ä¸€ç§å¯æ‰©å±•çš„I/Oäº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼‰æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰çš„æ´»åŠ¨çŠ¶æ€çš„ä¾‹å­<sup>3</sup> <sup>4</sup>ã€‚ä»£ç çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š

- é¦–å…ˆï¼Œå¯¹ä¸€ä¸ªfdå†æ¬¡è¿›è¡Œpollæ“ä½œï¼Œä»¥ç¡®è®¤äº‹ä»¶ã€‚ep_item_pollå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªreventså˜é‡ï¼Œè¡¨ç¤ºè¯¥fdä¸Šå‘ç”Ÿçš„äº‹ä»¶ç±»å‹ï¼ˆæ¯”å¦‚å¯è¯»ã€å¯å†™ç­‰ï¼‰ã€‚
- ç„¶åï¼Œå¦‚æœreventså˜é‡ä¸ç”¨æˆ·è¯·æ±‚çš„äº‹ä»¶æ©ç æœ‰äº¤é›†ï¼Œå°±å°†äº‹ä»¶ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ã€‚__put_userå‡½æ•°ä¼šå°†reventså’Œepi->event.dataï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ï¼‰å¤åˆ¶åˆ°ueventç»“æ„ä½“ä¸­ï¼Œueventæ˜¯ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚
- æ¥ç€ï¼Œå¦‚æœ__put_userå‡½æ•°å‡ºé”™ï¼Œå°±å°†epiï¼ˆè¡¨ç¤ºä¸€ä¸ªfdçš„ç»“æ„ä½“ï¼‰æ·»åŠ åˆ°headé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨ep_pm_stay_awakeå‡½æ•°é˜²æ­¢ç³»ç»Ÿè¿›å…¥ä¼‘çœ çŠ¶æ€ã€‚å¦‚æœå·²ç»æœ‰äº‹ä»¶è¢«ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ï¼Œå°±è¿”å›eventcntï¼ˆè¡¨ç¤ºä¼ é€’çš„äº‹ä»¶æ•°é‡ï¼‰ï¼Œå¦åˆ™è¿”å›-EFAULTï¼ˆè¡¨ç¤ºé”™è¯¯ï¼‰ã€‚
- æœ€åï¼Œå¦‚æœ__put_userå‡½æ•°æˆåŠŸï¼Œå°±å°†eventcntåŠ ä¸€ï¼Œå¹¶å°†ueventæŒ‡é’ˆå‘åç§»åŠ¨ä¸€ä¸ªå•ä½ï¼Œå‡†å¤‡ä¼ é€’ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚

è¯·é—®æ‚¨æ˜¯æƒ³äº†è§£epollçš„åŸºæœ¬åŸç†è¿˜æ˜¯å…·ä½“ç”¨æ³•å‘¢ï¼Ÿæ‚¨å¯ä»¥å‚è€ƒä»¥ä¸‹ç½‘å€<sup>1</sup> <sup>2</sup> <sup>4</sup> <sup>5</sup>æ¥å­¦ä¹ æ›´å¤šå…³äºepollçš„å†…å®¹ã€‚

\-
\[1]: [epoll - Wikipedia](https://en.wikipedia.org/wiki/Epoll)
\[2]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)
\[3]: [How to use epoll? A complete example in C - intrepidgeeks.com](https://intrepidgeeks.com/tutorial/how-to-use-epoll-a-complete-example-in-c)
\[4]: [Async IO on Linux: select, poll, and epoll - Julia Evans](https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/)
\[5]: [linux - How do I use epoll? - Stack Overflow](https://stackoverflow.com/questions/31230708/how-do-i-use-epoll)

<hr/>

