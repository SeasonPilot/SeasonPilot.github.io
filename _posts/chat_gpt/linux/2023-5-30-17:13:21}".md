---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).Explain the following code:
"static void ep_ptable_queue_proc(struct file *file, wait_queue_head_t *whead,poll_table *pt)
{
    struct epitem *epi = ep_item_from_epqueue(pt);
    struct eppoll_entry *pwq;
    if (epi>nwait >= 0 && (pwq = kmem_cache_alloc(pwq_cache, GFP_KERNEL))) {
        init_waitqueue_func_entry(&pwq->wait, ep_poll_callback);
        pwq->whead = whead;
        pwq->base = epi;
        if (epi->event.events & EPOLLEXCLUSIVE)
            add_wait_queue_exclusive(whead, &pwq->wait);
        else
            add_wait_queue(whead, &pwq->wait);
        list_add_tail(&pwq->llink, &epi->pwqlist);
        epi->nwait++;
    } else {
        /* We have to signal that an error occurred */
        epi->nwait = -1;
    }
}"

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘ä¼šç”¨ç®€ä½“ä¸­æ–‡å›å¤æ‚¨ã€‚ğŸ˜Š

è¿™æ®µä»£ç æ˜¯ç”¨Cè¯­è¨€ç¼–å†™çš„ï¼Œç”¨äºLinuxç³»ç»Ÿä¸­çš„epollæœºåˆ¶ã€‚epollæ˜¯ä¸€ç§é«˜æ•ˆçš„I/Oäº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå¯ä»¥ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€<sup>3</sup>ã€‚è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œåä¸ºep_ptable_queue_procï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼šfileã€wheadå’Œptã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªepitemç»“æ„ä½“ï¼ˆè¡¨ç¤ºä¸€ä¸ªepolläº‹ä»¶ï¼‰æ·»åŠ åˆ°ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¥ä¾¿åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”ŸI/Oäº‹ä»¶æ—¶è°ƒç”¨å›è°ƒå‡½æ•°ep_poll_callback<sup>4</sup>ã€‚

å‡½æ•°çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

- ä»ptå‚æ•°ä¸­è·å–epitemç»“æ„ä½“çš„æŒ‡é’ˆï¼Œèµ‹å€¼ç»™epiå˜é‡ã€‚
- å¦‚æœepiçš„nwaitå­—æ®µï¼ˆè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…ƒç´ ä¸ªæ•°ï¼‰å¤§äºç­‰äº0ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»pwq_cacheç¼“å­˜ä¸­åˆ†é…ä¸€ä¸ªeppoll_entryç»“æ„ä½“ï¼ˆè¡¨ç¤ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å…ƒç´ ï¼‰ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
    - ç”¨ep_poll_callbackå‡½æ•°åˆå§‹åŒ–pwqçš„waitå­—æ®µï¼ˆè¡¨ç¤ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹ï¼‰ã€‚
    - å°†wheadå‚æ•°èµ‹å€¼ç»™pwqçš„wheadå­—æ®µï¼ˆè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—çš„å¤´æŒ‡é’ˆï¼‰ã€‚
    - å°†epiå˜é‡èµ‹å€¼ç»™pwqçš„baseå­—æ®µï¼ˆè¡¨ç¤ºå…³è”çš„epitemç»“æ„ä½“ï¼‰ã€‚
    - å¦‚æœepiçš„eventå­—æ®µï¼ˆè¡¨ç¤ºäº‹ä»¶ç±»å‹ï¼‰åŒ…å«EPOLLEXCLUSIVEæ ‡å¿—ï¼ˆè¡¨ç¤ºç‹¬å æ¨¡å¼ï¼‰ï¼Œåˆ™è°ƒç”¨add_wait_queue_exclusiveå‡½æ•°å°†pwqçš„waitå­—æ®µæ·»åŠ åˆ°wheadæŒ‡å‘çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¦åˆ™è°ƒç”¨add_wait_queueå‡½æ•°æ·»åŠ ã€‚
    - å°†pwqå˜é‡æ·»åŠ åˆ°epiçš„pwqlistå­—æ®µï¼ˆè¡¨ç¤ºç­‰å¾…é˜Ÿåˆ—å…ƒç´ çš„é“¾è¡¨ï¼‰çš„å°¾éƒ¨ã€‚
    - å°†epiçš„nwaitå­—æ®µåŠ ä¸€ã€‚
- å¦åˆ™ï¼Œå°†epiçš„nwaitå­—æ®µè®¾ä¸º-1ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯ã€‚

è¿™å°±æ˜¯è¿™æ®µä»£ç çš„è§£é‡Šã€‚å¸Œæœ›å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚ğŸ‘

\-
\[1]: [epoll - Wikipedia](https://en.wikipedia.org/wiki/Epoll)
\[2]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)
\[3]: [How to use epoll? A complete example in C - intrepid Geeks](https://intrepidgeeks.com/tutorial/how-to-use-epoll-a-complete-example-in-c)
\[4]: [Async IO on Linux: select, poll, and epoll - Julia Evans](https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/)
\[5]: [linux - How do I use epoll? - Stack Overflow](https://stackoverflow.com/questions/31230708/how-do-i-use-epoll)

<hr/>

