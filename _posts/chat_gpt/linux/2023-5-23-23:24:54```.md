---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).Explain the following code:
"if (!(epi = kmem_cache_alloc(epi_cache, GFP_KERNEL)))"

Answer:

è¿™æ˜¯ Bingã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡å›ç­”ä½ çš„é—®é¢˜ã€‚ğŸ˜Š

è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š

å¦‚æœä» epi_cache è¿™ä¸ªç¼“å­˜ä¸­åˆ†é…å†…å­˜å¤±è´¥ï¼Œå°±æŠŠ epi è®¾ä¸º NULLã€‚

kmem_cache_alloc æ˜¯ä¸€ä¸ª Linux å†…æ ¸å‡½æ•°ï¼Œå®ƒç”¨äºä»ä¸€ä¸ªé¢„å…ˆåˆ›å»ºçš„ç¼“å­˜ä¸­åˆ†é…ä¸€å—å›ºå®šå¤§å°çš„å†…å­˜<sup>1</sup> <sup>2</sup>ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¼“å­˜çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åˆ†é…æ ‡å¿—ï¼Œæ¯”å¦‚ GFP_KERNELï¼Œè¡¨ç¤ºå¯ä»¥ç¡çœ ç­‰å¾…å†…å­˜<sup>2</sup>ã€‚

! æ˜¯ä¸€ä¸ªé€»è¾‘éè¿ç®—ç¬¦ï¼Œå®ƒæŠŠçœŸå€¼å–åã€‚å¦‚æœ kmem_cache_alloc è¿”å› NULLï¼Œè¡¨ç¤ºåˆ†é…å¤±è´¥ï¼Œ! ä¼šæŠŠå®ƒå˜æˆçœŸå€¼ï¼Œè¿›å…¥ if è¯­å¥ã€‚å¦‚æœ kmem_cache_alloc è¿”å›ä¸€ä¸ªé NULL çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºåˆ†é…æˆåŠŸï¼Œ! ä¼šæŠŠå®ƒå˜æˆå‡å€¼ï¼Œè·³è¿‡ if è¯­å¥ã€‚

\-
\[1]: [Memory Allocation Guide â€” The Linux Kernel documentation](https://www.kernel.org/doc/html/latest/core-api/memory-allocation.html)
\[2]: [Memory Management APIs â€” The Linux Kernel documentation](https://www.kernel.org/doc/html/latest/core-api/mm-api.html?highlight=kmem_cache_alloc)
\[3]: [Memory Allocation Guide â€” The Linux Kernel documentation](https://docs.kernel.org/6.1/core-api/memory-allocation.html)

<hr/>

Question:

Reply in Chinese (Simplified).Explain the following code:
```
if (!(epi = kmem_cache_alloc(epi_cache, GFP_KERNEL)))
        return -ENOMEM;
    /* Item initialization follow here ... */
     INIT_LIST_HEAD(&epi->rdllink);
    INIT_LIST_HEAD(&epi->fllink);
    INIT_LIST_HEAD(&epi->pwqlist);
    epi->ep = ep;
    ep_set_ffd(&epi->ffd, tfile, fd);
    epi->event = *event;
    epi->nwait = 0;
    epi->next = EP_UNACTIVE_PTR;
```

Answer:

è¿™æ˜¯ Bingã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡å›ç­”ä½ çš„é—®é¢˜ã€‚ğŸ˜Š

è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š

å¦‚æœä» epi_cache è¿™ä¸ªç¼“å­˜ä¸­åˆ†é…å†…å­˜å¤±è´¥ï¼Œå°±è¿”å› -ENOMEMï¼Œè¡¨ç¤ºæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ã€‚

å¦‚æœåˆ†é…æˆåŠŸï¼Œå°±å¯¹ epi è¿™ä¸ªç»“æ„ä½“è¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®å®ƒçš„å„ä¸ªå­—æ®µçš„å€¼ã€‚

epi æ˜¯ä¸€ä¸ª epoll_item çš„æŒ‡é’ˆï¼Œå®ƒè¡¨ç¤ºä¸€ä¸ªè¦è¢«ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦å’Œç›¸å…³çš„äº‹ä»¶<sup>3</sup> <sup>4</sup>ã€‚

epoll æ˜¯ä¸€ä¸ª Linux å†…æ ¸æä¾›çš„å¯æ‰©å±•çš„ I/O äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œçœ‹æ˜¯å¦æœ‰ I/O å¯èƒ½å‘ç”Ÿ<sup>1</sup> <sup>2</sup>ã€‚

INIT_LIST_HEAD æ˜¯ä¸€ä¸ªå®ï¼Œç”¨äºåˆå§‹åŒ–ä¸€ä¸ªåŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹<sup>5</sup>ã€‚

epi->rdllink, epi->fllink, epi->pwqlist éƒ½æ˜¯åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œåˆ†åˆ«ç”¨äºè¿æ¥å°±ç»ªé˜Ÿåˆ—ã€æ–‡ä»¶é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„ epoll_itemã€‚

epi->ep æ˜¯ä¸€ä¸ªæŒ‡å‘ epoll æ–‡ä»¶çš„æŒ‡é’ˆã€‚

ep_set_ffd æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºè®¾ç½® epi çš„ ffd å­—æ®µï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæŒ‡å‘è¢«ç›‘è§†æ–‡ä»¶çš„æŒ‡é’ˆå’Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚

epi->event æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨äºå­˜å‚¨è¦ç›‘è§†çš„äº‹ä»¶ç±»å‹å’Œç”¨æˆ·æ•°æ®ã€‚

epi->nwait æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè®°å½•æœ‰å¤šå°‘ä¸ªç­‰å¾…çº¿ç¨‹åœ¨ç­‰å¾…è¿™ä¸ª epoll_itemã€‚

epi->next æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨äºè¿æ¥åŒä¸€ä¸ªæ¡¶ä¸­çš„å…¶ä»– epoll_itemã€‚EP_UNACTIVE_PTR æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œè¡¨ç¤ºè¿™ä¸ª epoll_item ä¸åœ¨ä»»ä½•æ¡¶ä¸­ã€‚

\-
\[1]: [epoll(7): I/O event notification facility - Linux man page](https://linux.die.net/man/7/epoll)
\[2]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)
\[3]: [epoll - Wikipedia](https://en.wikipedia.org/wiki/Epoll)
\[4]: [Async IO on Linux: select, poll, and epoll - Julia Evans](https://jvns.ca/blog/2017/06/03/async-io-on-linux--select--poll--and-epoll/)
\[5]: [linux - How do I use epoll? - Stack Overflow](https://stackoverflow.com/questions/31230708/how-do-i-use-epoll)

<hr/>

