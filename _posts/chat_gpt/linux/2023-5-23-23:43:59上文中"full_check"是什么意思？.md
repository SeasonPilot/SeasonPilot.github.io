---
layout: post
categories: linux
---
Question:

Reply in Chinese (Simplified).Explain the following code:
"```
case EPOLL_CTL_ADD:
    if (!epi) {
        epds.events |= POLLERR | POLLHUP;
        error = ep_insert(ep, &epds, tf.file, fd, full_check);
    } else
        error = -EEXIST;
    if (full_check)
        clear_tfile_check_list();
    break;
```"

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘ä¼šç”¨ç®€ä½“ä¸­æ–‡å›å¤æ‚¨ã€‚ğŸ˜Š

è¿™æ®µä»£ç æ˜¯ç”¨Cè¯­è¨€ç¼–å†™çš„ï¼Œå®ƒæ˜¯epollçš„ä¸€ä¸ªæ“ä½œï¼Œç”¨äºåœ¨epollæ–‡ä»¶æè¿°ç¬¦çš„å…´è¶£åˆ—è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ¡ç›®ã€‚epollæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å˜åŒ–<sup>1</sup> <sup>2</sup>ã€‚

ä»£ç çš„å«ä¹‰æ˜¯ï¼š

- å¦‚æœopå‚æ•°æ˜¯EPOLL_CTL_ADDï¼Œè¡¨ç¤ºè¦æ·»åŠ ä¸€ä¸ªæ¡ç›®ã€‚
- å¦‚æœepiä¸ºç©ºï¼Œè¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦è¿˜æ²¡æœ‰åœ¨epollä¸­æ³¨å†Œï¼Œé‚£ä¹ˆå°±ç”¨ep_insertå‡½æ•°å°†å…¶æ’å…¥åˆ°epollä¸­ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„äº‹ä»¶å’Œæ–‡ä»¶ä¿¡æ¯ã€‚epds.events |= POLLERR | POLLHUPè¡¨ç¤ºåœ¨äº‹ä»¶ä¸­åŠ ä¸ŠPOLLERRå’ŒPOLLHUPä¸¤ä¸ªæ ‡å¿—ï¼Œåˆ†åˆ«è¡¨ç¤ºå‘ç”Ÿé”™è¯¯æˆ–è€…æŒ‚æ–­<sup>1</sup> <sup>2</sup>ã€‚
- å¦‚æœepiä¸ä¸ºç©ºï¼Œè¡¨ç¤ºè¯¥æ–‡ä»¶æè¿°ç¬¦å·²ç»åœ¨epollä¸­æ³¨å†Œè¿‡äº†ï¼Œé‚£ä¹ˆå°±è¿”å›ä¸€ä¸ªé”™è¯¯ç -EEXISTï¼Œè¡¨ç¤ºå·²ç»å­˜åœ¨<sup>1</sup> <sup>2</sup>ã€‚
- å¦‚æœfull_checkä¸ºçœŸï¼Œè¡¨ç¤ºè¦æ¸…é™¤tfile_check_listï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨äºæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æœ‰æ•ˆæ€§çš„åˆ—è¡¨<sup>3</sup>ã€‚
- breakè¡¨ç¤ºç»“æŸswitchè¯­å¥ã€‚

æ‚¨æ˜¯æƒ³äº†è§£æ›´å¤šå…³äºepollçš„ä¿¡æ¯å—ï¼Ÿæ‚¨å¯ä»¥å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚æˆ–è€…é—®é¢˜ã€‚ğŸ‘

\-
\[1]: [epoll_ctl(2) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man2/epoll_ctl.2.html)
\[2]: [epoll_ctl(2) - Linux man page](https://linux.die.net/man/2/epoll_ctl)
\[3]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)

<hr/>

Question:

ä¸Šæ–‡â€œepds.events |= POLLERR | POLLHUPâ€ ä¸­ |= æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

Answer:

|=æ˜¯ä¸€ä¸ªä½è¿ç®—ç¬¦ï¼Œå®ƒè¡¨ç¤ºæŒ‰ä½æˆ–èµ‹å€¼ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†å·¦è¾¹çš„æ“ä½œæ•°å’Œå³è¾¹çš„æ“ä½œæ•°è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®—ï¼Œç„¶åå°†ç»“æœèµ‹å€¼ç»™å·¦è¾¹çš„æ“ä½œæ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœx = 5ï¼Œy = 3ï¼Œé‚£ä¹ˆx |= yçš„ç»“æœæ˜¯x = x | y = 5 | 3 = 7<sup>1</sup> <sup>2</sup>ã€‚

æŒ‰ä½æˆ–è¿ç®—(|)æ˜¯ä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼Œå®ƒå¯¹ä¸¤ä¸ªé•¿åº¦ç›¸åŒçš„äºŒè¿›åˆ¶æ•°çš„æ¯ä¸€ä½è¿›è¡Œé€»è¾‘æˆ–è¿ç®—ã€‚å®ƒè¿”å›1ï¼Œå¦‚æœä¸¤ä¸ªå¯¹åº”çš„ä½ä¸­æœ‰ä¸€ä¸ªæˆ–ä¸¤ä¸ªéƒ½æ˜¯1ï¼Œå¦åˆ™è¿”å›0<sup>4</sup>ã€‚

æ‚¨æ˜¯å¦è¿˜æœ‰å…¶ä»–å…³äºCè¯­è¨€çš„é—®é¢˜ï¼Ÿæ‚¨å¯ä»¥å°è¯•è¾“å…¥ä¸€äº›ä»£ç ç‰‡æ®µï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨åˆ†æå’Œè§£é‡Šã€‚ğŸ˜Š

\-
\[1]: [C Bitwise OR and assignment operator - AlphaCodingSkills - Java](https://www.alphacodingskills.com/c/notes/c-operator-bitwise-or-assignment.php)
\[2]: [microcontroller - What do the C operators "&=" and "|=" do ...](https://electronics.stackexchange.com/questions/14943/what-do-the-c-operators-and-do)
\[3]: [Bitwise Operators in C/C++ - GeeksforGeeks](https://www.geeksforgeeks.org/bitwise-operators-in-c-cpp/)
\[4]: [Operators in C - GeeksforGeeks](https://www.geeksforgeeks.org/operators-in-c/)

<hr/>

Question:

â€epds.events |= POLLERR | POLLHUPè¡¨ç¤ºåœ¨äº‹ä»¶ä¸­åŠ ä¸ŠPOLLERRå’ŒPOLLHUPä¸¤ä¸ªæ ‡å¿—â€œæ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

Answer:

epds.events |= POLLERR | POLLHUPè¡¨ç¤ºåœ¨äº‹ä»¶ä¸­åŠ ä¸ŠPOLLERRå’ŒPOLLHUPä¸¤ä¸ªæ ‡å¿—ï¼Œæ˜¯å› ä¸ºè¿™ä¸¤ä¸ªæ ‡å¿—æ˜¯ç”¨äºæ£€æµ‹æ–‡ä»¶æè¿°ç¬¦çš„é”™è¯¯æˆ–æŒ‚æ–­çŠ¶æ€çš„ã€‚POLLERRè¡¨ç¤ºå‘ç”Ÿé”™è¯¯ï¼ŒPOLLHUPè¡¨ç¤ºæŒ‚æ–­<sup>1</sup>ã€‚è¿™ä¸¤ä¸ªæ ‡å¿—åªä¼šåœ¨reventsä¸­è¿”å›ï¼Œè€Œä¸ä¼šåœ¨eventsä¸­è®¾ç½®<sup>1</sup>ã€‚

å¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªç®¡é“æˆ–è€…å¥—æ¥å­—ï¼Œé‚£ä¹ˆå½“å†™ç«¯å…³é—­æ—¶ï¼Œè¯»ç«¯ä¼šæ”¶åˆ°POLLHUPäº‹ä»¶<sup>2</sup>ã€‚å¦‚æœå¯¹æ–¹å…³é—­äº†å¥—æ¥å­—ï¼Œé‚£ä¹ˆæœ¬åœ°ä¼šæ”¶åˆ°POLLIN|POLLHUPäº‹ä»¶<sup>2</sup>ã€‚å¦‚æœæ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªTCPå¥—æ¥å­—ï¼Œé‚£ä¹ˆPOLLERRè¡¨ç¤ºæ”¶åˆ°æˆ–å‘é€äº†RST<sup>3</sup>ã€‚

æ‚¨æ˜¯å¦è¿˜æœ‰å…¶ä»–å…³äºepollæˆ–è€…æ–‡ä»¶æè¿°ç¬¦çš„é—®é¢˜ï¼Ÿæ‚¨å¯ä»¥è¾“å…¥ä¸€äº›å…³é”®è¯æˆ–è€…é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨æŸ¥æ‰¾ç›¸å…³çš„ä¿¡æ¯ã€‚ğŸ‘

\-
\[1]: [poll(2) - Linux manual page - man7.org](https://www.man7.org/linux/man-pages/man2/poll.2.html)
\[2]: [c - POLLHUP vs POLLNVAL, or what is POLLHUP? - Stack Overflow](https://stackoverflow.com/questions/25147181/pollhup-vs-pollnval-or-what-is-pollhup)
\[3]: [How to handle the Linux socket revents POLLERR, POLLHUP and POLLNVAL ...](https://stackoverflow.com/questions/24791625/how-to-handle-the-linux-socket-revents-pollerr-pollhup-and-pollnval)

<hr/>

Question:

ä¸Šæ–‡ä¸­"full_check"æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

Answer:

full_checkæ˜¯ä¸€ä¸ªå˜é‡ï¼Œå®ƒç”¨äºæ§åˆ¶epoll_ctlå‡½æ•°æ˜¯å¦éœ€è¦å¯¹æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œå®Œæ•´çš„æ£€æŸ¥ã€‚å¦‚æœfull_checkä¸º1ï¼Œé‚£ä¹ˆepoll_ctlå‡½æ•°ä¼šéå†æ‰€æœ‰çš„epitemï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„æˆ–è€…æ— æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦<sup>2</sup>ã€‚å¦‚æœfull_checkä¸º0ï¼Œé‚£ä¹ˆepoll_ctlå‡½æ•°åªä¼šæ£€æŸ¥ä¼ å…¥çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰æ•ˆ<sup>2</sup>ã€‚

epoll_ctlå‡½æ•°æ˜¯ç”¨äºæ“ä½œepollå®ä¾‹çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦<sup>3</sup>ã€‚epollæ˜¯ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå®ƒå¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œçœ‹æ˜¯å¦æœ‰I/Oäº‹ä»¶å‘ç”Ÿ<sup>1</sup>ã€‚

æ‚¨æ˜¯å¦è¿˜æœ‰å…¶ä»–å…³äºfull_checkæˆ–è€…epoll_ctlçš„é—®é¢˜ï¼Ÿæ‚¨å¯ä»¥è¾“å…¥ä¸€äº›å…³é”®è¯æˆ–è€…é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›å¸®åŠ©æ‚¨æŸ¥æ‰¾ç›¸å…³çš„ä¿¡æ¯ã€‚ğŸ˜Š

\-
\[1]: [linux/eventpoll.c at master Â· torvalds/linux Â· GitHub](https://github.com/torvalds/linux/blob/master/fs/eventpoll.c)
\[2]: [epoll_ctl(2) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man2/epoll_ctl.2.html)
\[3]: [epoll(7) - Linux manual page - man7.org](https://man7.org/linux/man-pages/man7/epoll.7.html)

<hr/>

