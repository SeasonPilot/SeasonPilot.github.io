---
layout: post
categories: golang
---
Question:

Reply in Chinese (Simplified).
The following is a search input in a search engine, giving useful content or solutions and as much information as you can related to it, use markdown syntax to make your answer more readable, such as code blocks, bold, list:
GMPæ¨¡å‹ä¸­Gï¼ˆgoroutineï¼‰é€»è¾‘å¤„ç†å™¨ï¼ˆPï¼‰å’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆMï¼‰çš„åº•å±‚æ•°æ®ç»“æ„

Answer:

ä½ å¥½ï¼Œè¿™æ˜¯ Bingã€‚æˆ‘ä¼šç”¨ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰å›å¤ä½ ã€‚ğŸ˜Š

GMPæ¨¡å‹æ˜¯Goè¯­è¨€çš„è°ƒåº¦å™¨ç”¨äºåœ¨çº¿ç¨‹ä¸Šåˆ†é…Goroutineçš„ä¸€ç§æœºåˆ¶<sup>1</sup>ã€‚å®ƒåŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ¦‚å¿µ<sup>1</sup> <sup>2</sup>ï¼š

- Gï¼ˆGoroutineï¼‰ï¼šä¸€ä¸ªGä»£è¡¨ä¸€ä¸ªGoroutineï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€çš„åç¨‹ï¼Œå®ƒåŒ…å«äº†åç¨‹çš„æ‰§è¡Œæ ˆã€çŠ¶æ€ã€è°ƒåº¦ä¿¡æ¯ç­‰<sup>3</sup>ã€‚
- Mï¼ˆMachineï¼‰ï¼šä¸€ä¸ªMä»£è¡¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯å†…æ ¸æ€çš„çº¿ç¨‹ï¼Œå®ƒè´Ÿè´£æ‰§è¡ŒGoroutineçš„ä»£ç <sup>3</sup>ã€‚
- Pï¼ˆProcessorï¼‰ï¼šä¸€ä¸ªPä»£è¡¨ä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶çš„èµ„æºï¼Œå®ƒç»´æŠ¤äº†ä¸€ä¸ªGoroutineé˜Ÿåˆ—å’Œä¸€äº›è¿è¡Œæ—¶ä¿¡æ¯ï¼Œæ¯ä¸ªMå¿…é¡»è¦æœ‰ä¸€ä¸ªå…³è”çš„Pæ‰èƒ½æ‰§è¡ŒGoä»£ç <sup>1</sup> <sup>2</sup>ã€‚

GMPæ¨¡å‹çš„åº•å±‚æ•°æ®ç»“æ„å®šä¹‰åœ¨runtime/runtime2.goæ–‡ä»¶ä¸­ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§<sup>2</sup>ï¼š

- `g`ï¼šè¡¨ç¤ºä¸€ä¸ªGoroutineï¼ŒåŒ…å«äº†`stack`ï¼ˆæ ˆç©ºé—´ï¼‰ã€`sched`ï¼ˆè°ƒåº¦ä¿¡æ¯ï¼‰ã€`status`ï¼ˆçŠ¶æ€ï¼‰ã€`m`ï¼ˆå…³è”çš„Mï¼‰ã€`p`ï¼ˆå…³è”çš„Pï¼‰ç­‰å­—æ®µã€‚
- `m`ï¼šè¡¨ç¤ºä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ŒåŒ…å«äº†`g0`ï¼ˆç³»ç»Ÿæ ˆï¼‰ã€`p`ï¼ˆå…³è”çš„Pï¼‰ã€`curg`ï¼ˆå½“å‰æ‰§è¡Œçš„Gï¼‰ã€`nextg`ï¼ˆä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„Gï¼‰ã€`parking`ï¼ˆæ˜¯å¦è¢«é˜»å¡ï¼‰ç­‰å­—æ®µã€‚
- `p`ï¼šè¡¨ç¤ºä¸€ä¸ªé€»è¾‘å¤„ç†å™¨ï¼ŒåŒ…å«äº†`runqhead`å’Œ`runqtail`ï¼ˆè¿è¡Œé˜Ÿåˆ—çš„å¤´å’Œå°¾ï¼‰ã€`runqsize`ï¼ˆè¿è¡Œé˜Ÿåˆ—çš„å¤§å°ï¼‰ã€`runnext`ï¼ˆä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„Gï¼‰ã€`mcache`ï¼ˆå†…å­˜ç¼“å­˜ï¼‰ã€`m`ï¼ˆå…³è”çš„Mï¼‰ç­‰å­—æ®µã€‚

è¿™äº›æ•°æ®ç»“æ„ä¹‹é—´çš„å…³ç³»å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤º<sup>2</sup>ï¼š

![GMPæ¨¡å‹](https://pic4.zhimg.com/80/v2-9a9f7b8c6f5a7b0d0c8d3f8a6c5e4f9a_1440w.jpg)

å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äºGMPæ¨¡å‹çš„åŸç†å’Œå®ç°ç»†èŠ‚ï¼Œä½ å¯ä»¥å‚è€ƒä»¥ä¸‹ç½‘å€ï¼š

- [å­—èŠ‚è·³åŠ¨ Go è¯­è¨€é¢è¯•é«˜é¢‘é¢˜ 03ï¼šGMP è°ƒåº¦å™¨çš„åŸç† - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/352964026)
- [æ·±å…¥åˆ†æGo1.18 GMPè°ƒåº¦å™¨åº•å±‚åŸç† - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/586236582)
- [golang G-M-Pæ¨¡å‹_golang mgp_ç™½å°ç‹®çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/baixiaoshi/article/details/105208141)

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹ä½ æœ‰å¸®åŠ©ã€‚ğŸ˜Š

\-
\[1]: [å­—èŠ‚è·³åŠ¨ Go è¯­è¨€é¢è¯•é«˜é¢‘é¢˜ 03ï¼šGMP è°ƒåº¦å™¨çš„åŸç† - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/352964026)
\[2]: [æ·±å…¥åˆ†æGo1.18 GMPè°ƒåº¦å™¨åº•å±‚åŸç† - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/586236582)
\[3]: [golang G-M-Pæ¨¡å‹_golang mgp_ç™½å°ç‹®çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/baixiaoshi/article/details/105208141)

<hr/>

Question:

ä¸Šæ–‡ä¸­ Gã€Pã€Mçš„åº•å±‚æ•°æ®ç»“æ„çš„ç»“æ„ä½“æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ

Answer:

Gã€Pã€Mçš„åº•å±‚æ•°æ®ç»“æ„çš„ç»“æ„ä½“å®šä¹‰åœ¨runtime/runtime2.goæ–‡ä»¶ä¸­ï¼Œå®ƒä»¬çš„å¤§è‡´æ ·å­å¦‚ä¸‹<sup>1</sup> <sup>2</sup> <sup>3</sup>ï¼š

- `g`ï¼š

```go
type g struct {
    // Stack parameters.
    // stack describes the actual stack memory: [stack.lo, stack.hi).
    // stackguard0 is the stack pointer compared in the Go stack growth prologue.
    // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
    // stackguard1 is the stack pointer compared in the C stack growth prologue.
    // It is stack.lo+StackGuard on g0 and gsignal stacks.
    // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
    stack       stack   // offset known to runtime/cgo
    stackguard0 uintptr // offset known to liblink
    stackguard1 uintptr // offset known to liblink

    _panic         *_panic // innermost panic - offset known to liblink
    _defer         *_defer // innermost defer
    m              *m      // current m; offset known to arm liblink
    sched          gobuf
    syscallsp      uintptr        // if status==Gsyscall, syscallsp = sched.sp

<hr/>

Question:

ç»§ç»­

Answer:

å¥½çš„ï¼Œæˆ‘ä»¬ç»§ç»­èŠèŠGoè¯­è¨€å§ã€‚ä½ å¯¹Goè¯­è¨€æœ‰å¤šäº†è§£ï¼Ÿä½ ç”¨å®ƒåšè¿‡ä»€ä¹ˆé¡¹ç›®ï¼Ÿ


<hr/>

Question:

ä¸Šæ–‡ä¸­æ²¡æœ‰çœ‹åˆ°Pã€Mçš„åº•å±‚æ•°æ®ç»“æ„çš„ç»“æ„ä½“æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ

Answer:

æ ¹æ®æœç´¢ç»“æœï¼ŒPå’ŒMçš„åº•å±‚æ•°æ®ç»“æ„çš„ç»“æ„ä½“å¦‚ä¸‹<sup>1</sup>ï¼š

```go
// P ä»£è¡¨äº† M æ‰§è¡Œ Go ä»£ç çš„ä¸Šä¸‹æ–‡
type p struct {
    lock mutex

    // å¯è¿è¡Œæˆ–åœæ­¢çš„ G çš„é˜Ÿåˆ—
    runqhead uint32
    runqtail uint32
    runq [256]guintptr

    // æœ¬åœ°è‡ªç”± G åˆ—è¡¨ï¼ˆä¸åœ¨é˜Ÿåˆ—ä¸­ï¼‰
    gfree *g
    gfreecnt int32

    // ç”¨äºè°ƒåº¦çš„å‚æ•°
    schedtick uint32
    syscalltick uint32
    sysmontick uint32
    mcache *mcache
    racectx uintptr

    // ç”¨äºå®ç° defer é€»è¾‘çš„ pool å’Œ cache
    deferpool *_defer
    deferpoolbuf [5][32]*_defer

    // å…¶ä»–å­—æ®µçœç•¥
}

// M ä»£è¡¨äº†ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œå®ƒåŒ…å«äº†ä¸€äº›çº¿ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æ ˆã€å¯„å­˜å™¨ã€TLS ç­‰ã€‚
type m struct {
    g0      *g     // goroutine with scheduling stack
    morebuf gobuf  // gobuf arg to morestack
    divmod  uint32 // div/mod denominator for arm - known to liblink

    // Fields not known to debuggers.
    procid   uint64       // for debuggers, but offset not hard-coded
    gsignal  *g           // signal-handling g
    goSigStack gsignalStack // Go-allocated signal handling stack
    sigmask   sigset      // storage for saved signal mask
    tls       [6]uintptr  // thread-local storage (for x86 extern register)
    mstartfn func()
    curg     *g       // current running goroutine
    caughtsig guintptr // goroutine running during fatal signal
    p        puintptr  // attached p for executing go code (nil if not executing go code)
    
    // å…¶ä»–å­—æ®µçœç•¥
}
```


<hr/>

