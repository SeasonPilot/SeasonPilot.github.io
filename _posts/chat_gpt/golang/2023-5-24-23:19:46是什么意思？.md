---
layout: post
categories: golang
---
Question:

Reply in Chinese (Simplified).
The following is a search input in a search engine, giving useful content or solutions and as much information as you can related to it, use markdown syntax to make your answer more readable, such as code blocks, bold, list:
```
static void ep_ptable_queue_proc(struct file *file, wait_queue_head_t *whead, poll_table *pt) {
    struct epitem *epi = ep_item_from_epqueue(pt);
    struct eppoll_entry *pwq;

    if (epi > nwait >= && (pwq = kmem_cache_alloc(pwq_cache, GFP_KERNEL))) {
        init_waitqueue_func_entry(&pwq->wait, ep_poll_callback);
        pwq->whead = whead;
        pwq->base = epi;
        if (epi->event.events & EPOLLEXCLUSIVE)
            add_wait_queue_exclusive(whead, &pwq->wait);
        else
            add_wait_queue(whead, &pwq->wait);
        list_add_tail(&pwq->llink, &epi->pwqlist);
        epi->nwait++;
    } else {
        /* We have to signal that an error occurred */
        epi->nwait = -1;
    }
}
```

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡å›å¤æ‚¨ã€‚ğŸ˜Š

æ‚¨è¾“å…¥çš„æ˜¯ä¸€ä¸ªLinuxå†…æ ¸ä¸­çš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å…³è”èµ·æ¥ï¼Œä»¥ä¾¿åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿäº‹ä»¶æ—¶ï¼Œèƒ½å¤Ÿå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹<sup>1</sup> <sup>2</sup>ã€‚è¿™ä¸ªå‡½æ•°æ˜¯epollæœºåˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œepollæ˜¯ä¸€ç§é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯<sup>3</sup> <sup>4</sup> <sup>5</sup>ã€‚

è¿™ä¸ªå‡½æ•°çš„å‚æ•°å¦‚ä¸‹ï¼š

- file: ä¸€ä¸ªæŒ‡å‘struct fileçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
- whead: ä¸€ä¸ªæŒ‡å‘wait_queue_head_tçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦å…³è”çš„ç­‰å¾…é˜Ÿåˆ—ã€‚
- pt: ä¸€ä¸ªæŒ‡å‘poll_tableçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºepollä½¿ç”¨çš„è½®è¯¢è¡¨ã€‚

è¿™ä¸ªå‡½æ•°çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š

- ä»ptä¸­è·å–å¯¹åº”çš„struct epitemï¼Œå®ƒæ˜¯epollä¸­ç”¨æ¥å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ä¿¡æ¯çš„ç»“æ„ä½“ã€‚
- å¦‚æœepitemçš„nwaitå­—æ®µä¸ä¸ºè´Ÿæ•°ï¼Œè¯´æ˜è¿˜æœ‰ç©ºé—´å¯ä»¥æ·»åŠ æ–°çš„ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œå°±ä»pwq_cacheä¸­åˆ†é…ä¸€ä¸ªstruct eppoll_entryï¼Œå®ƒæ˜¯ç”¨æ¥å­˜å‚¨ç­‰å¾…é˜Ÿåˆ—é¡¹å’Œepitemä¹‹é—´å…³ç³»çš„ç»“æ„ä½“ã€‚
- åˆå§‹åŒ–eppoll_entryä¸­çš„waitå­—æ®µï¼Œè®¾ç½®ep_poll_callbackä¸ºå”¤é†’æ—¶çš„å›è°ƒå‡½æ•°ã€‚
- è®¾ç½®eppoll_entryä¸­çš„wheadå’Œbaseå­—æ®µï¼Œåˆ†åˆ«æŒ‡å‘wheadå’Œepitemã€‚
- æ ¹æ®epitemä¸­çš„eventå­—æ®µï¼Œåˆ¤æ–­æ˜¯ä½¿ç”¨ç‹¬å æ¨¡å¼è¿˜æ˜¯å…±äº«æ¨¡å¼ï¼Œç„¶åå°†eppoll_entryä¸­çš„waitå­—æ®µåŠ å…¥åˆ°wheadæ‰€æŒ‡å‘çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚
- å°†eppoll_entryåŠ å…¥åˆ°epitemä¸­çš„pwqlisté“¾è¡¨ä¸­ï¼Œå¹¶å°†epitemä¸­çš„nwaitå­—æ®µåŠ ä¸€ã€‚
- å¦‚æœepitemä¸­çš„nwaitå­—æ®µä¸ºè´Ÿæ•°ï¼Œè¯´æ˜æ²¡æœ‰ç©ºé—´å¯ä»¥æ·»åŠ æ–°çš„ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œå°±å°†å…¶è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºå‡ºé”™ã€‚

æ‚¨æ˜¯å¦å¯¹è¿™ä¸ªå‡½æ•°æœ‰ä»€ä¹ˆç‰¹å®šçš„é—®é¢˜æˆ–éœ€æ±‚ï¼Ÿå¦‚æœæœ‰ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ğŸ‘

\-
\[1]: [The Implementation of epoll (2) - idndx.com](https://idndx.com/the-implementation-of-epoll-2/)
\[2]: [Linux kernel Note: epoll implementation principle - Alibaba Cloud Topic ...](https://topic.alibabacloud.com/a/linux-kernel-note-epoll-implementation-principle_1_16_30161550.html)
\[3]: [Epoll/ep_ptable_queue_proc at master Â· grasslog/Epoll Â· GitHub](https://github.com/grasslog/Epoll/blob/master/ep_ptable_queue_proc)
\[4]: [linux - The detail function about epoll_insert - Stack Overflow](https://stackoverflow.com/questions/38800281/the-detail-function-about-epoll-insert)
\[5]: [golang from kernel to epoll - SoByte](https://www.sobyte.net/post/2021-10/golang-from-kernel-to-epoll/)

<hr/>

Question:

ä¸Šæ–‡ä¸­"list_add_tail() "

Answer:

list_add_tailæ˜¯ä¸€ä¸ªLinuxå†…æ ¸ä¸­çš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–°çš„é“¾è¡¨é¡¹æ·»åŠ åˆ°ä¸€ä¸ªå·²æœ‰çš„é“¾è¡¨çš„å°¾éƒ¨<sup>1</sup> <sup>2</sup> <sup>3</sup>ã€‚å®ƒçš„å‚æ•°å¦‚ä¸‹ï¼š

- new: ä¸€ä¸ªæŒ‡å‘struct list_headçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦æ·»åŠ çš„æ–°çš„é“¾è¡¨é¡¹ã€‚
- head: ä¸€ä¸ªæŒ‡å‘struct list_headçš„æŒ‡é’ˆï¼Œè¡¨ç¤ºå·²æœ‰çš„é“¾è¡¨çš„å¤´éƒ¨ã€‚

è¿™ä¸ªå‡½æ•°çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š

- å°†newçš„prevå­—æ®µæŒ‡å‘headçš„prevå­—æ®µï¼Œè¡¨ç¤ºnewçš„å‰ä¸€ä¸ªé“¾è¡¨é¡¹æ˜¯åŸæ¥é“¾è¡¨çš„æœ€åä¸€ä¸ªé“¾è¡¨é¡¹ã€‚
- å°†newçš„nextå­—æ®µæŒ‡å‘headï¼Œè¡¨ç¤ºnewçš„åä¸€ä¸ªé“¾è¡¨é¡¹æ˜¯headã€‚
- å°†headçš„prevå­—æ®µçš„nextå­—æ®µæŒ‡å‘newï¼Œè¡¨ç¤ºåŸæ¥é“¾è¡¨çš„æœ€åä¸€ä¸ªé“¾è¡¨é¡¹çš„åä¸€ä¸ªé“¾è¡¨é¡¹æ˜¯newã€‚
- å°†headçš„prevå­—æ®µæŒ‡å‘newï¼Œè¡¨ç¤ºheadçš„å‰ä¸€ä¸ªé“¾è¡¨é¡¹æ˜¯newã€‚

æ‚¨æ˜¯å¦å¯¹è¿™ä¸ªå‡½æ•°æœ‰ä»€ä¹ˆç‰¹å®šçš„é—®é¢˜æˆ–éœ€æ±‚ï¼Ÿå¦‚æœæœ‰ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ğŸ‘

\-
\[1]: [Linked Lists - Linux Device Drivers, Second Edition [Book] - O'Reilly Media](https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch10s05.html)
\[2]: [list_add_tail(9) [suse man page] - The UNIX and Linux Forums](https://www.unix.com/man-page/suse/9/list_add_tail)
\[3]: [11.5. Linked Lists - makelinux.net](http://makelinux.net/ldd3/chp-11-sect-5.shtml)
\[4]: [linux/list.h at master Â· torvalds/linux Â· GitHub](https://github.com/torvalds/linux/blob/master/include/linux/list.h)
\[5]: [c - Adding items to a Linux kernel linked list - Stack Overflow](https://stackoverflow.com/questions/33933344/adding-items-to-a-linux-kernel-linked-list)

<hr/>

Question:

ä¸Šæ–‡ä¸­"poll_tableï¼Œè¡¨ç¤ºepollä½¿ç”¨çš„è½®è¯¢è¡¨"è½®è¯¢è¡¨æ˜¯ä»€ä¹ˆ

Answer:

poll_tableæ˜¯ä¸€ä¸ªLinuxå†…æ ¸ä¸­çš„ç»“æ„ä½“ï¼Œå®ƒç”¨äºåœ¨å†…æ ¸ä¸­å®ç°pollå’Œselectç³»ç»Ÿè°ƒç”¨<sup>1</sup>ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```c
typedef void (*poll_queue_proc) (struct file *, wait_queue_head_t *, struct poll_table_struct *);
typedef struct poll_table_struct {
    poll_queue_proc qproc;
} poll_table;
```

å®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆstruct file *ï¼‰å’Œä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å¤´ï¼ˆwait_queue_head_t *ï¼‰å…³è”èµ·æ¥ï¼Œä»¥ä¾¿åœ¨æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”ŸæŸäº›äº‹ä»¶æ—¶ï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹<sup>2</sup>ã€‚

æ‚¨æ˜¯å¦å¯¹poll_tableæœ‰ä»€ä¹ˆç‰¹å®šçš„é—®é¢˜æˆ–éœ€æ±‚ï¼Ÿå¦‚æœæœ‰ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ğŸ˜Š

\-
\[1]: [poll and select - Linux Device Drivers, Second Edition [Book]](https://www.oreilly.com/library/view/linux-device-drivers/0596000081/ch05s03.html)
\[2]: [in linux char device driver, what does the poll_queue_proc function do ...](https://stackoverflow.com/questions/61515031/in-linux-char-device-driver-what-does-the-poll-queue-proc-function-do)
\[3]: [poll(2) - Linux manual page - man7.org](https://www.man7.org/linux/man-pages/man2/poll.2.html)
\[4]: [TTY Line Discipline â€” The Linux Kernel documentation](https://docs.kernel.org/driver-api/tty/tty_ldisc.html)

<hr/>

Question:

ä¸Šæ–‡ä¸­"å·²æœ‰çš„é“¾è¡¨"æ˜¯ä¸ªå¾ªç¯é“¾è¡¨ï¼Ÿ

Answer:

æ˜¯çš„ï¼Œå·²æœ‰çš„é“¾è¡¨æ˜¯ä¸€ä¸ªå¾ªç¯é“¾è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ çš„nextå­—æ®µæŒ‡å‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè€Œé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„prevå­—æ®µæŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æ–¹ä¾¿åœ°éå†é“¾è¡¨ï¼Œè€Œä¸éœ€è¦åˆ¤æ–­é“¾è¡¨æ˜¯å¦åˆ°è¾¾äº†æœ«å°¾[^1^ã€‚


<hr/>

Question:

eventpollã€ epitem å’Œ eppoll_entry ä¹‹é—´çš„å…³è”å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿè¯·ä½¿ç”¨ mermaid å›¾è¡¨ç¤º

Answer:

eventpollã€ epitem å’Œ eppoll_entry æ˜¯Linuxå†…æ ¸ä¸­å®ç°epollæœºåˆ¶çš„ä¸‰ä¸ªé‡è¦çš„æ•°æ®ç»“æ„<sup>2</sup>ã€‚å®ƒä»¬ä¹‹é—´çš„å…³è”å…³ç³»å¦‚ä¸‹ï¼š

```mermaid
classDiagram
    class eventpoll {
        -struct file *file
        -struct list_head rdllist
        -struct rb_root rbr
        -struct mutex mtx
    }
    class epitem {
        -struct rb_node rbn
        -struct list_head rdllink
        -struct epoll_filefd ffd
        -struct eventpoll *ep
        -struct eppoll_entry *pwqlist
    }
    class eppoll_entry {
        -struct list_head llink
        -wait_queue_t wait
        -wait_queue_head_t *whead
        -struct epitem *base
    }
    eventpoll "1" -- "0..*" epitem : contains
    epitem "1" -- "0..*" eppoll_entry : contains
```

eventpollè¡¨ç¤ºä¸€ä¸ªepollå®ä¾‹ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆï¼ˆfileï¼‰ã€ä¸€ä¸ªå°±ç»ªäº‹ä»¶é“¾è¡¨ï¼ˆrdllistï¼‰ã€ä¸€ä¸ªçº¢é»‘æ ‘ï¼ˆrbrï¼‰å’Œä¸€ä¸ªäº’æ–¥é”ï¼ˆmtxï¼‰<sup>1</sup> <sup>3</sup>ã€‚

epitemè¡¨ç¤ºä¸€ä¸ªè¢«ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªçº¢é»‘æ ‘èŠ‚ç‚¹ï¼ˆrbnï¼‰ã€ä¸€ä¸ªå°±ç»ªäº‹ä»¶é“¾è¡¨èŠ‚ç‚¹ï¼ˆrdllinkï¼‰ã€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»“æ„ä½“ï¼ˆffdï¼‰ã€ä¸€ä¸ªæŒ‡å‘eventpollçš„æŒ‡é’ˆï¼ˆepï¼‰å’Œä¸€ä¸ªæŒ‡å‘eppoll_entryçš„æŒ‡é’ˆï¼ˆpwqlistï¼‰<sup>2</sup> <sup>4</sup>ã€‚

eppoll_entryè¡¨ç¤ºä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼ˆllinkï¼‰ã€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—é¡¹ï¼ˆwaitï¼‰ã€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å¤´æŒ‡é’ˆï¼ˆwheadï¼‰å’Œä¸€ä¸ªæŒ‡å‘epitemçš„æŒ‡é’ˆï¼ˆbaseï¼‰<sup>2</sup> <sup>4</sup>ã€‚

æ‚¨æ˜¯å¦å¯¹è¿™äº›æ•°æ®ç»“æ„æœ‰ä»€ä¹ˆç‰¹å®šçš„é—®é¢˜æˆ–éœ€æ±‚ï¼Ÿå¦‚æœæœ‰ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ğŸ˜Š

\-
\[1]: [LibraryCodeComments/eventpoll.c at master Â· RandyLambert ... - GitHub](https://github.com/RandyLambert/LibraryCodeComments/blob/master/epoll/eventpoll.c)
\[2]: [Linux kernel Note: epoll implementation principle - Alibaba Cloud Topic ...](https://topic.alibabacloud.com/a/linux-kernel-note-epoll-implementation-principle_1_16_30161550.html)
\[3]: [exploiting CVE-2019-2215 | cutesmileeâ€™s blog](https://cutesmilee.github.io/kernel/linux/android/2022/02/17/cve-2019-2215_writeup.html)
\[4]: [linux/eventpoll.c at master Â· torvalds/linux Â· GitHub](https://github.com/torvalds/linux/blob/master/fs/eventpoll.c)
\[5]: [process - What information can I find out about an eventpoll on a ...](https://unix.stackexchange.com/questions/126196/what-information-can-i-find-out-about-an-eventpoll-on-a-running-thread)
\[6]: [How does the Linux kernel remove a closed fd from the epoll interest ...](https://stackoverflow.com/questions/68635003/how-does-the-linux-kernel-remove-a-closed-fd-from-the-epoll-interest-list)

<hr/>

Question:

ä¸Šæ–‡ä¸­
```
    eventpoll "1" -- "0..*" epitem : contains
    epitem "1" -- "0..*" eppoll_entry : contains
```
æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

Answer:

è¿™æ˜¯mermaidå›¾çš„è¯­æ³•ï¼Œè¡¨ç¤ºç±»ä¹‹é—´çš„å…³ç³»ã€‚eventpoll "1" -- "0..*" epitem : contains è¡¨ç¤ºä¸€ä¸ªeventpollåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªepitemï¼Œepitem "1" -- "0..*" eppoll_entry : contains è¡¨ç¤ºä¸€ä¸ªepitemåŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªeppoll_entryã€‚æ‚¨å¯ä»¥åœ¨[è¿™é‡Œ](https://mermaid-js.github.io/mermaid/#/classDiagram)æŸ¥çœ‹æ›´å¤šå…³äºmermaidå›¾çš„ä¿¡æ¯ã€‚


<hr/>

