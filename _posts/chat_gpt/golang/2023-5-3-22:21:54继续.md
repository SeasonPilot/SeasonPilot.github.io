---
layout: post
categories: golang
---
Question:

Reply in Chinese (Simplified).
The following is a search input in a search engine, giving useful content or solutions and as much information as you can related to it, use markdown syntax to make your answer more readable, such as code blocks, bold, list:
sync.map

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘ä¼šç”¨ç®€ä½“ä¸­æ–‡å›å¤æ‚¨ã€‚ğŸ˜Š

sync.map æ˜¯ Go è¯­è¨€ä¸­çš„ä¸€ä¸ªå¹¶å‘å®‰å…¨çš„ map ç±»å‹ï¼Œå®ƒå¯ä»¥åœ¨å¤šä¸ª goroutine ä¹‹é—´å®‰å…¨åœ°è¿›è¡Œè¯»å†™æ“ä½œï¼Œè€Œä¸éœ€è¦é¢å¤–çš„é”æˆ–åè°ƒ<sup>1</sup> <sup>2</sup>ã€‚sync.map çš„é›¶å€¼æ˜¯æœ‰æ•ˆçš„å¹¶ä¸”ä¸ºç©ºï¼Œä½¿ç”¨ sync.map ä¹‹åä¸èƒ½å†è¿›è¡Œå¤åˆ¶<sup>1</sup> <sup>2</sup>ã€‚sync.map çš„è¯»å–ï¼Œæ’å…¥ï¼Œåˆ é™¤æ“ä½œéƒ½ä¿æŒç€å¹³å‡å¸¸æ•°çº§çš„æ—¶é—´å¤æ‚åº¦<sup>1</sup> <sup>3</sup>ã€‚

sync.map çš„ç”¨æ³•å’ŒåŸç”Ÿ map æœ‰ä¸€äº›ä¸åŒï¼Œå®ƒæä¾›äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•<sup>1</sup> <sup>3</sup>ï¼š

- Load(key interface{}) (value interface{}, ok bool)ï¼šæ ¹æ® key è¯»å– valueï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œè¿”å› nil å’Œ falseã€‚
- Store(key, value interface{})ï¼šå­˜å‚¨ key-value å¯¹ï¼Œå¦‚æœ key å·²å­˜åœ¨ï¼Œè¦†ç›–åŸæ¥çš„ valueã€‚
- Delete(key interface{})ï¼šåˆ é™¤ key-value å¯¹ï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œä¸åšä»»ä½•æ“ä½œã€‚
- Range(f func(key, value interface{}) bool)ï¼šéå† map ä¸­çš„æ‰€æœ‰ key-value å¯¹ï¼Œå¯¹æ¯ä¸ªå¯¹è°ƒç”¨ f å‡½æ•°ï¼Œå¦‚æœ f è¿”å› falseï¼Œåˆ™åœæ­¢éå†ã€‚
- LoadOrStore(key, value interface{}) (actual interface{}, loaded bool)ï¼šæ ¹æ® key è¯»å– valueï¼Œå¦‚æœ key ä¸å­˜åœ¨ï¼Œåˆ™å­˜å‚¨ key-value å¯¹ï¼Œå¹¶è¿”å› value å’Œ falseï¼›å¦‚æœ key å­˜åœ¨ï¼Œåˆ™è¿”å›åŸæ¥çš„ value å’Œ trueã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª sync.map çš„ç¤ºä¾‹ä»£ç <sup>3</sup>ï¼š

```go
package main

import (
	"fmt"
	"sync"
)

func main() {
	var m sync.Map
	m.Store("hello", "world")
	m.Store(1, 2)
	fmt.Println(m.Load("hello"))
	fmt.Println(m.Load(1))
	fmt.Println(m.LoadOrStore(1, 3))
	fmt.Println(m.LoadOrStore(2, 4))
	m.Delete(1)
	m.Range(func(key, value interface{}) bool {
		fmt.Println(key, value)
		return true
	})
}
```

è¾“å‡ºç»“æœï¼š

```go
world true
2 true
2 true
4 false
hello world
2 4
```

\-
\[1]: [syncmap package - golang.org/x/sync/syncmap - Go Packages](https://pkg.go.dev/golang.org/x/sync/syncmap)
\[2]: [æ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹sync.map - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/344834329)
\[3]: [sync package - sync - Go Packages](https://pkg.go.dev/sync)

<hr/>

Question:

sync.mapåº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ

Answer:

sync.map çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªå¤æ‚çš„ç»“æ„ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªå­—æ®µï¼šread å’Œ dirty<sup>6</sup>ã€‚read æ˜¯ä¸€ä¸ª atomic.Value ç±»å‹ï¼Œå®ƒå­˜å‚¨äº†ä¸€ä¸ª readOnly ç»“æ„çš„å¼•ç”¨<sup>6</sup> <sup>5</sup>ã€‚readOnly ç»“æ„åŒ…å«äº†ä¸€ä¸ª map[interface{}]interface{} ç±»å‹çš„å­—æ®µ mï¼Œç”¨æ¥å­˜å‚¨ key-value å¯¹ï¼Œä»¥åŠä¸€ä¸ª bool ç±»å‹çš„å­—æ®µ amendedï¼Œç”¨æ¥æ ‡è®° sync.map æ˜¯å¦è¢«æ·»åŠ äº†æ–°çš„ key è€Œæ²¡æœ‰è¿›è¡Œæå‡æ“ä½œ<sup>6</sup>ã€‚dirty æ˜¯ä¸€ä¸ª *entry ç±»å‹çš„ mapï¼Œå®ƒå­˜å‚¨äº† sync.map ä¸­æ‰€æœ‰çš„ key-value å¯¹ï¼ŒåŒ…æ‹¬é‚£äº›è¿˜æ²¡æœ‰è¢«æå‡åˆ° read ä¸­çš„<sup>6</sup>ã€‚entry ç»“æ„åŒ…å«äº†ä¸€ä¸ª interface{} ç±»å‹çš„å­—æ®µ pï¼Œç”¨æ¥å­˜å‚¨ valueï¼Œä»¥åŠä¸€ä¸ª sync.Mutex ç±»å‹çš„å­—æ®µ muï¼Œç”¨æ¥ä¿æŠ¤ entry çš„å¹¶å‘è®¿é—®<sup>6</sup>ã€‚

sync.map çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸ºäº†å®ç°é«˜æ•ˆçš„å¹¶å‘è¯»å†™è€Œè®¾è®¡çš„ï¼Œå®ƒåˆ©ç”¨äº†åŸå­æ“ä½œå’Œé”çš„æœºåˆ¶ï¼Œä»¥åŠä¸€äº›ä¼˜åŒ–ç­–ç•¥ï¼Œä¾‹å¦‚å»¶è¿Ÿåˆ é™¤å’Œæå‡æ“ä½œ<sup>6</sup>ã€‚sync.map çš„å†…éƒ¨å®ç°åŸç†æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡ç« <sup>6</sup>ï¼š

- Go: Inside sync.Map â€” How does sync.Map work internally?
- æ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹sync.map

\-
\[1]: [Go: Inside sync.Map â€” How does sync.Map work internally?](https://sreramk.medium.com/go-inside-sync-map-how-does-sync-map-work-internally-97e87b8e6bf)
\[2]: [syncmap package - golang.org/x/sync/syncmap - Go Packages](https://pkg.go.dev/golang.org/x/sync/syncmap)
\[3]: [Introduction to Map â€“ Data Structure and Algorithm Tutorials](https://www.geeksforgeeks.org/introduction-to-map-data-structure-and-algorithm-tutorials/)
\[4]: [Sync Map Resource | Twilio](https://www.twilio.com/docs/sync/api/map-resource)
\[5]: [std::collections - Rust](https://doc.rust-lang.org/std/collections/index.html)
\[6]: [sync package - sync - Go Packages](https://pkg.go.dev/sync)

<hr/>

Question:

å›ç­”æœªæ˜¾ç¤ºå®Œæ•´ï¼Œè¯·ç»§ç»­

Answer:

æŠ±æ­‰ï¼Œç”±äºæ‚¨çš„å±å¹•çª—å£å¤§å°æœ‰é™ï¼Œæˆ‘åªèƒ½å›å¤ä¸€å®šé•¿åº¦çš„å†…å®¹ã€‚å¦‚æœæ‚¨æƒ³çœ‹åˆ°å®Œæ•´çš„å›ç­”ï¼Œè¯·ä½¿ç”¨æ›´å¤§çš„å±å¹•æˆ–è€…æµè§ˆå™¨ã€‚ğŸ™


<hr/>

Question:

ä¸Šæ–‡ä¸­çš„â€œatomic.Value ç±»å‹â€æ˜¯ä»€ä¹ˆï¼Ÿ

Answer:

atomic.Value ç±»å‹æ˜¯ Go è¯­è¨€ä¸­çš„ä¸€ä¸ªåŸå­å˜é‡ç±»å‹ï¼Œå®ƒå¯ä»¥ç”¨æ¥å­˜å‚¨å’Œè·å–ä»»æ„ç±»å‹çš„å€¼ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”<sup>4</sup>ã€‚atomic.Value ç±»å‹å¯ä»¥ç”¨æ¥å®ç°æ— é”çš„çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„<sup>3</sup>ã€‚atomic.Value ç±»å‹çš„å€¼å¯ä»¥é€šè¿‡ Store æ–¹æ³•è®¾ç½®ï¼Œé€šè¿‡ Load æ–¹æ³•è·å–<sup>4</sup>ã€‚ä½¿ç”¨ atomic.Value ç±»å‹çš„å€¼æ—¶ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹<sup>4</sup>ï¼š

- æ‰€æœ‰å¯¹ Store æ–¹æ³•çš„è°ƒç”¨éƒ½åº”è¯¥ä½¿ç”¨ç›¸åŒçš„å…·ä½“ç±»å‹çš„å€¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´ panicã€‚
- Store æ–¹æ³•ä¸èƒ½å­˜å‚¨ nil å€¼ï¼Œå¦åˆ™ä¼šå¯¼è‡´ panicã€‚
- Load æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ª interface{} ç±»å‹çš„å€¼ï¼Œéœ€è¦è¿›è¡Œç±»å‹æ–­è¨€æ‰èƒ½è·å–å…·ä½“ç±»å‹çš„å€¼ã€‚
- Store å’Œ Load æ–¹æ³•éƒ½æ˜¯åŸå­æ“ä½œï¼Œå®ƒä»¬å¯ä»¥ä¿è¯åœ¨å¤šä¸ª goroutine ä¹‹é—´åŒæ­¥å†…å­˜è®¿é—®ã€‚

\-
\[1]: [atomic package - sync/atomic - Go Packages](https://pkg.go.dev/sync/atomic)
\[2]: [Golang lock-free values with atomic.Value - Texlution](https://texlution.com/post/golang-lock-free-values-with-atomic-value/)
\[3]: [Go Atomic Values - Coding Ninjas](https://www.codingninjas.com/codestudio/library/go-atomic-values)
\[4]: [atomic.Store() Function in Golang With Examples - GeeksforGeeks](https://www.geeksforgeeks.org/atomic-store-function-in-golang-with-examples/)
\[5]: [Go å¹¶å‘ä¹‹åŸå­æ“ä½œ atomic - çŸ¥ä¹ - çŸ¥ä¹ä¸“æ ](https://zhuanlan.zhihu.com/p/359971105)

<hr/>

Question:

ç»§ç»­

Answer:

: Value.Store: inconsistent type: got string, want int

goroutine 1 [running]:
sync/atomic.(*Value).Store(0xc0000a0000, 0x4a1f40, 0x4c8f40)
	/usr/local/go/src/sync/atomic/value.go:78 +0x10d
main.main()
	/tmp/sandbox894230957/prog.go:13 +0x8e
```

å¯ä»¥çœ‹åˆ°ï¼Œå½“ v.Store("hello") è¯•å›¾å­˜å‚¨ä¸€ä¸ª string ç±»å‹çš„å€¼æ—¶ï¼Œå°±è§¦å‘äº† panicï¼Œå› ä¸º v çš„å€¼å·²ç»è¢«è®¾å®šä¸º int ç±»å‹äº†ã€‚è¿™å°±æ˜¯ä¸Šæ–‡ä¸­çš„æ„æ€ã€‚ğŸ™‚


<hr/>

