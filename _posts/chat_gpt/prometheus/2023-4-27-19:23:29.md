---
layout: post
categories: prometheus
---
Question:

Reply in Chinese (Simplified).
The following is the text content of a web page,analyze the core content and summarize:
CAUTION: This page documents an old version of Prometheus. Check out the latest stable version.
CONFIGURATION
Configuration file
<scrape_config>
<tls_config>
<azure_sd_config>
<consul_sd_config>
<dns_sd_config>
<ec2_sd_config>
<openstack_sd_config>
<file_sd_config>
<gce_sd_config>
<kubernetes_sd_config>
<marathon_sd_config>
<nerve_sd_config>
<serverset_sd_config>
<triton_sd_config>
<static_config>
<relabel_config>
<metric_relabel_configs>
<alert_relabel_configs>
<alertmanager_config>
<remote_write>
<remote_read>Prometheus is configured via command-line flags and a configuration file. While the command-line flags configure immutable system parameters (such as storage locations,amount of data to keep on disk and in memory,etc.),the configuration file defines everything related to scraping jobs and their instances,as well as which rule files to load.To view all available command-line flags,run prometheus -h.Prometheus can reload its configuration at runtime. If the new configuration is not well-formed,the changes will not be applied. A configuration reload is triggered by sending a SIGHUP to the Prometheus process or sending a HTTP POST request to the /-/reload endpoint. This will also reload any configured rule files.Configuration fileTo specify which configuration file to load,remote storage,one scrape configuration specifies a single job. In advanced configurations,and labels generated by service discovery implementations).
#
# If honor_labels is set to "true",they are always applied only
# when a time series does not have a given label yet and are ignored otherwise.
[ honor_labels: <boolean> | default = false ]# Configures the protocol scheme used for requests.
[ scheme: <scheme> | default = http ]# Optional HTTP URL parameters.
params:
[ <string>: [<string>,]
Note that the IP number and port used to scrape the targets is assembled as <__meta_consul_address>:<__meta_consul_service_port>. However,but not the advanced DNS-SD approach specified in RFC6763.During the relabeling phase,but may be changed to the public IP address with relabeling.The following meta labels are available on targets during relabeling:__meta_ec2_availability_zone: the availability zone in which the instance is running
__meta_ec2_instance_id: the EC2 instance ID
__meta_ec2_instance_state: the state of the EC2 instance
__meta_ec2_instance_type: the type of the EC2 instance
__meta_ec2_private_ip: the private IP address of the instance,if availableSee below for the configuration options for EC2 discovery:# The information to access the EC2 API.# The AWS Region.
region: <string># The AWS API keys. If blank,it will often be populated by a provider-level
# function.
[ identity_endpoint: <string> ]# username is required if using Identity V2 API. Consult with your provider's
# control panel to discover your account's username. In Identity V3,using this format:[
{
"targets": [ "<host>",the file contents are also re-read periodically at the specified refresh interval.Each target has a meta label __meta_filepath during the relabeling phase. Its value is set to the filepath from which the target was extracted.There is a list of integrations with this discovery mechanism.# Patterns for files from which target groups are extracted.
files:
[ - <filename_pattern> ... ]# Refresh interval to re-read the files.
[ refresh_interval: <duration> | default = 5m ]
Where <filename_pattern> may be a path ending in .json,if present
__meta_gce_subnetwork: the subnetwork URL of the instance
__meta_gce_tags: comma separated list of instance tags
__meta_gce_zone: the GCE zone URL in which the instance is runningSee below for the configuration options for GCE discovery:# The information to access the GCE API.# The GCP Project
project: <string># The zone of the scrape targets. If you need multiple zones use multiple
# gce_sd_configs.
zone: <string># Filter can be used optionally to filter the instance list by other criteria
# Syntax of this filter string is described here in the filter query parameter section:
# https://cloud.google.com/compute/docs/reference/latest/instances/list
[ filter: <string> ]# Refresh interval to re-read the instance list
[ refresh_interval: <duration> | default = 60s ]# The port to scrape metrics from. If using the public IP address,NodeExternalIP,the instance label for the node will be set to the node name as retrieved from the API server.serviceThe service role discovers a target for each service port for each service. This is generally useful for blackbox monitoring of a service. The address will be set to the Kubernetes DNS name of the service and respective service port.Available meta labels:__meta_kubernetes_namespace: The namespace of the service object.
__meta_kubernetes_service_name: The name of the service object.
__meta_kubernetes_service_label_<labelname>: The label of the service object.
__meta_kubernetes_service_annotation_<annotationname>: The annotation of the service object.
__meta_kubernetes_service_port_name: Name of the service port for the target.
__meta_kubernetes_service_port_number: Number of the service port for the target.
__meta_kubernetes_service_port_protocol: Protocol of the service port for the target.
podThe pod role discovers all pods and exposes their containers as targets. For each declared port of a container,are discovered as targets as well.Available meta labels:__meta_kubernetes_namespace: The namespace of the endpoints object.
__meta_kubernetes_endpoints_name: The names of the endpoints object.
For all targets discovered directly from the endpoints list (those not additionally inferred from underlying pods),https if TLS config is set. Defaults to http.
__meta_kubernetes_ingress_path: Path from ingress spec. Defaults to /.See below for the configuration options for Kubernetes discovery:# The information to access the Kubernetes API.# The API server addresses. If left empty,service,you can use a Marathon label and Prometheus relabeling to control which instances will actually be scraped. Also by default all apps will show up as a single job in Prometheus (the one specified in the configuration file),the Thrift format is not currently supported.<triton_sd_config>
CAUTION: Triton SD is in beta: breaking changes to configuration are still likely in future releases.Triton SD configurations allow retrieving scrape targets from Container Monitor discovery endpoints.The following meta labels are available on targets during relabeling:__meta_triton_machine_id: the UUID of the target container
__meta_triton_machine_alias: the alias of the target container
__meta_triton_machine_image: the target containers image type
__meta_triton_machine_server_id: the server UUID for the target container
# The information to access the Triton discovery API.# The account to use for discovering new target containers.
account: <string># The DNS suffix which should be applied to target containers.
dns_suffix: <string># The Triton discovery endpoint (e.g. 'cmon.us-east-3b.triton.zone'). This is
# often the same value as dns_suffix.
endpoint: <string># The port to use for discovery and metric scraping.
[ port: <int> | default = 9163 ]# The interval which should should be used for refreshing target containers.
[ refresh_interval: <duration> | default = 60s ]# The Triton discovery API version.
[ version: <int> | default = 1 ]# TLS configuration.
tls_config:
[ <tls_config> ]<static_config>A static_config allows specifying a list of targets and a common label set for them. It is the canonical way to specify static targets in a scrape configuration.# The targets specified by the static config.
targets:
[ - '<host>' ]# Labels assigned to all metrics scraped from the targets.
labels:
[ <labelname>: <labelvalue> ... ]<relabel_config>Relabeling is a powerful tool to dynamically rewrite the label set of a target before it gets scraped. Multiple relabeling steps can be configured per scrape configuration. They are applied to the label set of each target in order of their appearance in the configuration file.Initially,keep,keep,set target_label to replacement,no replacement takes place.
keep: Drop targets for which regex does not match the concatenated source_labels.
drop: Drop targets for which regex matches the concatenated source_labels.
hashmod: Set target_label to the modulus of a hash of the concatenated source_labels.
labelmap: Match regex against all label names. Then copy the values of the matching labels to label names given by replacement with match group references (${1},

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘å¯ä»¥ç”¨ä¸­æ–‡å›å¤æ‚¨ã€‚ğŸ˜Š

æ‚¨ç»™å‡ºçš„ç½‘é¡µæ–‡æœ¬å†…å®¹æ˜¯å…³äº Prometheus çš„é…ç½®æ–‡ä»¶çš„ã€‚Prometheus æ˜¯ä¸€ä¸ªå¼€æºçš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿï¼Œå¯ä»¥æ”¶é›†å’Œå¤„ç†å¤šç§æ•°æ®æºçš„æŒ‡æ ‡æ•°æ®ã€‚Prometheus çš„é…ç½®æ–‡ä»¶æ˜¯ç”¨ YAML æ ¼å¼ç¼–å†™çš„ï¼Œç”¨äºå®šä¹‰å¦‚ä½•æŠ“å–ç›®æ ‡æ•°æ®æºçš„ä¿¡æ¯ï¼Œä»¥åŠåŠ è½½å“ªäº›è§„åˆ™æ–‡ä»¶ã€‚é…ç½®æ–‡ä»¶çš„åç§°é€šå¸¸æ˜¯ prometheus.ymlï¼ŒPrometheus ä¸‹è½½åŒ…ä¸­æœ‰ä¸€ä¸ªç¤ºä¾‹é…ç½®æ–‡ä»¶å¯ä»¥å‚è€ƒ<sup>1</sup> <sup>2</sup>ã€‚

é…ç½®æ–‡ä»¶ä¸­æœ‰å¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ä¸åŒçš„ä½œç”¨å’Œå‚æ•°ã€‚è¿™é‡Œç®€è¦ä»‹ç»ä¸€äº›å¸¸è§çš„éƒ¨åˆ†ï¼š

- <scrape_config>: å®šä¹‰ä¸€ä¸ªæŠ“å–ä»»åŠ¡ï¼ŒæŒ‡å®šè¦æŠ“å–çš„ç›®æ ‡åœ°å€ã€æ ‡ç­¾ã€åè®®ã€å‚æ•°ç­‰ã€‚
- <tls_config>: å®šä¹‰ TLS è¿æ¥çš„è®¾ç½®ï¼Œå¦‚è¯ä¹¦ã€å¯†é’¥ã€éªŒè¯ç­‰ã€‚
- <*_sd_config>: å®šä¹‰å„ç§æœåŠ¡å‘ç°çš„è®¾ç½®ï¼Œå¦‚ Azure, Consul, DNS, EC2, GCE, Kubernetes ç­‰ï¼Œç”¨äºåŠ¨æ€å‘ç°ç›®æ ‡åœ°å€ã€‚
- <file_sd_config>: å®šä¹‰ä»æ–‡ä»¶ä¸­è¯»å–ç›®æ ‡åœ°å€çš„è®¾ç½®ï¼Œæ”¯æŒ JSON å’Œ YAML æ ¼å¼çš„æ–‡ä»¶ã€‚
- <relabel_config>: å®šä¹‰åœ¨æŠ“å–ä¹‹å‰å¯¹ç›®æ ‡æ ‡ç­¾é›†è¿›è¡ŒåŠ¨æ€é‡å†™çš„è§„åˆ™ï¼Œå¯ä»¥å®ç°è¿‡æ»¤ã€ä¿®æ”¹ã€å“ˆå¸Œç­‰æ“ä½œã€‚
- <metric_relabel_configs>: å®šä¹‰åœ¨æŠ“å–ä¹‹åå¯¹æŒ‡æ ‡æ ‡ç­¾é›†è¿›è¡ŒåŠ¨æ€é‡å†™çš„è§„åˆ™ï¼Œå¯ä»¥å®ç°è¿‡æ»¤ã€ä¿®æ”¹ã€å“ˆå¸Œç­‰æ“ä½œã€‚
- <alert_relabel_configs>: å®šä¹‰åœ¨å‘é€å‘Šè­¦ä¹‹å‰å¯¹å‘Šè­¦æ ‡ç­¾é›†è¿›è¡ŒåŠ¨æ€é‡å†™çš„è§„åˆ™ï¼Œå¯ä»¥å®ç°è¿‡æ»¤ã€ä¿®æ”¹ã€å“ˆå¸Œç­‰æ“ä½œã€‚
- <alertmanager_config>: å®šä¹‰ä¸ Alertmanager é€šä¿¡çš„è®¾ç½®ï¼Œå¦‚åœ°å€ã€è¶…æ—¶ã€API ç‰ˆæœ¬ç­‰ã€‚
- <remote_write>: å®šä¹‰å°†æŒ‡æ ‡æ•°æ®è¿œç¨‹å†™å…¥å…¶ä»–ç³»ç»Ÿçš„è®¾ç½®ï¼Œå¦‚ URLã€é˜Ÿåˆ—ã€é‡è¯•ç­‰ã€‚
- <remote_read>: å®šä¹‰ä»å…¶ä»–ç³»ç»Ÿè¿œç¨‹è¯»å–æŒ‡æ ‡æ•°æ®çš„è®¾ç½®ï¼Œå¦‚ URLã€è¶…æ—¶ã€é‡è¯•ç­‰ã€‚

ä»¥ä¸Šæ˜¯å¯¹ç½‘é¡µæ–‡æœ¬å†…å®¹çš„æ ¸å¿ƒå†…å®¹å’Œæ¦‚æ‹¬ã€‚å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº Prometheus é…ç½®æ–‡ä»¶çš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£<sup>2</sup>ã€‚

\-
\[1]: [First steps | Prometheus](https://prometheus.io/docs/introduction/first_steps/)
\[2]: [Configuration | Prometheus](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)
\[3]: [Getting started | Prometheus](https://prometheus.io/docs/prometheus/latest/getting_started/)

<hr/>

Question:

```
      relabel_configs:
        - action: keep
          regex: test1;taliban(.*)
          source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_service_name
        - source_labels: [__meta_job_name]
          target_label: myscrapejob1
          replacement: job1


Answer:

æ‚¨ç»™å‡ºçš„æ˜¯ä¸€ä¸ª Prometheus é…ç½®æ–‡ä»¶ä¸­çš„ relabel_configs éƒ¨åˆ†ï¼Œç”¨äºåœ¨æŠ“å–ä¹‹å‰å¯¹ç›®æ ‡æ ‡ç­¾é›†è¿›è¡ŒåŠ¨æ€é‡å†™ã€‚è¿™ä¸ªéƒ¨åˆ†çš„ä½œç”¨æ˜¯ï¼š

- ä¿ç•™é‚£äº›å‘½åç©ºé—´ä¸º test1 å¹¶ä¸”æœåŠ¡åä»¥ taliban å¼€å¤´çš„ç›®æ ‡ï¼Œå…¶ä»–çš„ç›®æ ‡éƒ½ä¸¢å¼ƒã€‚
- å°†æ‰€æœ‰ç›®æ ‡çš„ __meta_job_name æ ‡ç­¾çš„å€¼æ›¿æ¢ä¸º job1ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ ‡ç­¾é‡å‘½åä¸º myscrapejob1ã€‚

è¿™æ ·å¯ä»¥å®ç°å¯¹ç›®æ ‡çš„è¿‡æ»¤å’Œæ ‡ç­¾çš„ä¿®æ”¹ã€‚å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº relabel_configs çš„å‚æ•°å’Œç”¨æ³•ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£[^2^ã€‚


<hr/>

Question:

ä¸Šæ–‡ä¸­â€œå°†æ‰€æœ‰ç›®æ ‡çš„ __meta_job_name æ ‡ç­¾çš„å€¼æ›¿æ¢ä¸º job1ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ ‡ç­¾é‡å‘½åä¸º myscrapejob1ã€‚â€ é‡å‘½åå __meta_job_name æ ‡ç­¾è¿˜åœ¨å—ï¼Ÿ

Answer:

é‡å‘½ååï¼Œ__meta_job_name æ ‡ç­¾å°±ä¸åœ¨äº†ï¼Œåªæœ‰ myscrapejob1 æ ‡ç­¾ã€‚target_label å‚æ•°æŒ‡å®šäº†æ–°çš„æ ‡ç­¾åï¼Œå¦‚æœä¸æŒ‡å®šï¼Œå°±ä¼šä¿ç•™åŸæ¥çš„æ ‡ç­¾åã€‚replacement å‚æ•°æŒ‡å®šäº†æ–°çš„æ ‡ç­¾å€¼ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œå°±ä¼šä¿ç•™åŸæ¥çš„æ ‡ç­¾å€¼ã€‚


<hr/>

Question:

å¦‚æœè¦ä¿ç•™åŸæ¥çš„æ ‡ç­¾åï¼ŒPrometheus é…ç½®æ–‡ä»¶ä¸­çš„ relabel_configs éƒ¨åˆ†åº”è¯¥æ€ä¹ˆå†™ï¼Ÿ

Answer:

å¦‚æœè¦ä¿ç•™åŸæ¥çš„æ ‡ç­¾åï¼Œå¯ä»¥ä¸å†™ target_label å‚æ•°ï¼Œæˆ–è€…å†™æˆ target_label: __meta_job_nameã€‚ä¾‹å¦‚ï¼š

```yaml
      relabel_configs:
        - action: keep
          regex: test1;taliban(.*)
          source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_service_name
        - source_labels: [__meta_job_name]
          target_label: __meta_job_name
          replacement: job1
```

æˆ–è€…

```yaml
      relabel_configs:
        - action: keep
          regex: test1;taliban(.*)
          source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_service_name
        - source_labels: [__meta_job_name]
          replacement: job1
```

è¿™æ ·å°±ä¼šä¿ç•™ __meta_job_name æ ‡ç­¾ï¼Œä½†æ˜¯æŠŠå®ƒçš„å€¼æ›¿æ¢ä¸º job1ã€‚


<hr/>

Question:

ä¸Šæ–‡ä¸­â€œ__meta_job_nameâ€ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

Answer:

æ‚¨åˆšæ‰å·²ç»é—®è¿‡è¿™ä¸ªé—®é¢˜äº†ï¼Œæˆ‘å·²ç»å›ç­”è¿‡äº†ã€‚è¯·æ‚¨çœ‹ä¸€ä¸‹ä¸Šé¢çš„å›å¤ã€‚ğŸ˜Š


<hr/>

Question:

__meta_job_name æ˜¯ä¸€ä¸ª Prometheus è‡ªåŠ¨æ·»åŠ çš„æ ‡ç­¾ï¼Œç”¨äºæ ‡è¯†æŠ“å–çš„ç›®æ ‡å±äºå“ªä¸ªé…ç½®çš„ job1ã€‚job æ˜¯ä¸€ç»„å…·æœ‰ç›¸åŒç›®çš„çš„å®ä¾‹ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼‰çš„é›†åˆï¼Œä¾‹å¦‚ä¸€ä¸ª API æœåŠ¡å™¨ job å¯ä»¥æœ‰å››ä¸ªå¤åˆ¶çš„å®ä¾‹1ã€‚__meta_job_name çš„å€¼å°±æ˜¯é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„ job_name å‚æ•°ã€‚æ‚¨å¯ä»¥é€šè¿‡ relabel_configs å¯¹è¿™ä¸ªæ ‡ç­¾è¿›è¡Œé‡å†™æˆ–ä¿ç•™ã€‚

Answer:

æ‚¨ç»™å‡ºçš„æ˜¯æˆ‘ä¸Šä¸€æ¡å›å¤çš„å†…å®¹ï¼Œæ‚¨æ˜¯æƒ³ç¡®è®¤ä¸€ä¸‹å—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆæ‚¨çš„ç†è§£æ˜¯æ­£ç¡®çš„ã€‚å¦‚æœæ‚¨æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿ç»§ç»­æé—®ã€‚ğŸ˜Š


<hr/>

