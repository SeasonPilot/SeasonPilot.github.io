---
layout: post
categories: prometheus
---
Question:

Reply in Chinese (Simplified).Analyze the following content and express your opinion,or give your answer:
"<relabel_config>
Relabeling is a powerful tool to dynamically rewrite the label set of a target before it gets scraped. Multiple relabeling steps can be configured per scrape configuration. They are applied to the label set of each target in order of their appearance in the configuration file.

Initially, aside from the configured per-target labels, a target's job label is set to the job_name value of the respective scrape configuration. The __address__ label is set to the <host>:<port> address of the target. After relabeling, the instance label is set to the value of __address__ by default if it was not set during relabeling. The __scheme__ and __metrics_path__ labels are set to the scheme and metrics path of the target respectively. The __param_<name> label is set to the value of the first passed URL parameter called <name>.

Additional labels prefixed with __meta_ may be available during the relabeling phase. They are set by the service discovery mechanism that provided the target and vary between mechanisms.

Labels starting with __ will be removed from the label set after relabeling is completed.

If a relabeling step needs to store a label value only temporarily (as the input to a subsequent relabeling step), use the __tmp label name prefix. This prefix is guaranteed to never be used by Prometheus itself.

# The source labels select values from existing labels. Their content is concatenated
# using the configured separator and matched against the configured regular expression
# for the replace, keep, and drop actions.
[ source_labels: '[' <labelname> [, ...] ']' ]

# Separator placed between concatenated source label values.
[ separator: <string> | default = ; ]

# Label to which the resulting value is written in a replace action.
# It is mandatory for replace actions. Regex capture groups are available.
[ target_label: <labelname> ]

# Regular expression against which the extracted value is matched.
[ regex: <regex> | default = (.*) ]

# Modulus to take of the hash of the source label values.
[ modulus: <uint64> ]

# Replacement value against which a regex replace is performed if the
# regular expression matches. Regex capture groups are available.
[ replacement: <string> | default = $1 ]

# Action to perform based on regex matching.
[ action: <relabel_action> | default = replace ]
<regex> is any valid RE2 regular expression. It is required for the replace, keep, drop, labelmap,labeldrop and labelkeep actions. The regex is anchored on both ends. To un-anchor the regex, use .*<regex>.*.

<relabel_action> determines the relabeling action to take:

replace: Match regex against the concatenated source_labels. Then, set target_label to replacement, with match group references (${1}, ${2}, ...) in replacement substituted by their value. If regex does not match, no replacement takes place.
keep: Drop targets for which regex does not match the concatenated source_labels.
drop: Drop targets for which regex matches the concatenated source_labels.
hashmod: Set target_label to the modulus of a hash of the concatenated source_labels.
labelmap: Match regex against all label names. Then copy the values of the matching labels to label names given by replacement with match group references (${1}, ${2}, ...) in replacement substituted by their value.
labeldrop: Match regex against all label names. Any label that matches will be removed from the set of labels.
labelkeep: Match regex against all label names. Any label that does not match will be removed from the set of labels.
Care must be taken with labeldrop and labelkeep to ensure that metrics are still uniquely labeled once the labels are removed."

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æä»¥ä¸‹å†…å®¹ï¼Œå¹¶è¡¨è¾¾æˆ‘çš„æ„è§æˆ–ç»™å‡ºæˆ‘çš„ç­”æ¡ˆï¼š

"<relabel_config>
Relabelingæ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨æŠ“å–ç›®æ ‡ä¹‹å‰åŠ¨æ€åœ°é‡å†™ç›®æ ‡çš„æ ‡ç­¾é›†ã€‚æ¯ä¸ªæŠ“å–é…ç½®å¯ä»¥é…ç½®å¤šä¸ªé‡æ ‡è®°æ­¥éª¤ã€‚å®ƒä»¬æŒ‰ç…§å®ƒä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºåº”ç”¨äºæ¯ä¸ªç›®æ ‡çš„æ ‡ç­¾é›†ã€‚

æœ€åˆï¼Œé™¤äº†é…ç½®çš„æ¯ä¸ªç›®æ ‡æ ‡ç­¾å¤–ï¼Œç›®æ ‡çš„jobæ ‡ç­¾è¢«è®¾ç½®ä¸ºç›¸åº”æŠ“å–é…ç½®çš„job_nameå€¼ã€‚__address__æ ‡ç­¾è¢«è®¾ç½®ä¸ºç›®æ ‡çš„<host>:<port>åœ°å€ã€‚é‡æ ‡è®°åï¼Œå¦‚æœåœ¨é‡æ ‡è®°è¿‡ç¨‹ä¸­æ²¡æœ‰è®¾ç½®instanceæ ‡ç­¾ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°†å…¶è®¾ç½®ä¸º__address__çš„å€¼ã€‚__scheme__å’Œ__metrics_path__æ ‡ç­¾åˆ†åˆ«è®¾ç½®ä¸ºç›®æ ‡çš„æ–¹æ¡ˆå’Œåº¦é‡è·¯å¾„ã€‚__param_<name>æ ‡ç­¾è¢«è®¾ç½®ä¸ºç¬¬ä¸€ä¸ªä¼ é€’çš„URLå‚æ•°<name>çš„å€¼ã€‚

åœ¨é‡æ ‡è®°é˜¶æ®µæœŸé—´ï¼Œå¯èƒ½ä¼šæä¾›ä»¥__meta_ä¸ºå‰ç¼€çš„é™„åŠ æ ‡ç­¾ã€‚å®ƒä»¬ç”±æä¾›ç›®æ ‡çš„æœåŠ¡å‘ç°æœºåˆ¶è®¾ç½®ï¼Œå¹¶å› æœºåˆ¶è€Œå¼‚ã€‚

ä»¥__å¼€å¤´çš„æ ‡ç­¾å°†åœ¨é‡æ ‡è®°å®Œæˆåä»æ ‡ç­¾é›†ä¸­åˆ é™¤ã€‚

å¦‚æœä¸€ä¸ªé‡æ ‡è®°æ­¥éª¤éœ€è¦ä¸´æ—¶å­˜å‚¨ä¸€ä¸ªæ ‡ç­¾å€¼ï¼ˆä½œä¸ºåç»­é‡æ ‡è®°æ­¥éª¤çš„è¾“å…¥ï¼‰ï¼Œè¯·ä½¿ç”¨__tmpæ ‡ç­¾åå‰ç¼€ã€‚è¿™ä¸ªå‰ç¼€ä¿è¯æ°¸è¿œä¸ä¼šè¢«Prometheusæœ¬èº«ä½¿ç”¨ã€‚

# æºæ ‡ç­¾ä»ç°æœ‰æ ‡ç­¾ä¸­é€‰æ‹©å€¼ã€‚å®ƒä»¬çš„å†…å®¹ä½¿ç”¨é…ç½®çš„åˆ†éš”ç¬¦è¿æ¥
# å¹¶æ ¹æ®é…ç½®çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
# ç”¨äºæ›¿æ¢ã€ä¿ç•™å’Œåˆ é™¤æ“ä½œã€‚
[ source_labels: '[' <labelname> [, ...] ']' ]

# è¿æ¥æºæ ‡ç­¾å€¼æ—¶ä½¿ç”¨çš„åˆ†éš”ç¬¦ã€‚
[ separator: <string> | default = ; ]

# æ›¿æ¢æ“ä½œä¸­å°†ç»“æœå€¼å†™å…¥çš„æ ‡ç­¾ã€‚
# å®ƒå¯¹äºæ›¿æ¢æ“ä½œæ˜¯å¿…éœ€çš„ã€‚æ­£åˆ™æ•è·ç»„å¯ç”¨ã€‚
[ target_label: <labelname> ]

# ä¸æå–å€¼åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
[ regex: <regex> | default = (.*) ]

# æºæ ‡ç­¾å€¼å“ˆå¸Œçš„æ¨¡æ•°ã€‚
[ modulus: <uint64> ]

# å¦‚æœæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œåˆ™æ‰§è¡Œæ­£åˆ™æ›¿æ¢çš„æ›¿æ¢å€¼ã€‚
# æ­£åˆ™æ•è·ç»„å¯ç”¨ã€‚
[ replacement: <string> | default = $1 ]

# åŸºäºæ­£åˆ™åŒ¹é…æ‰§è¡Œçš„æ“ä½œã€‚
[ action: <relabel_action> | default = replace ]
<regex>æ˜¯ä»»ä½•æœ‰æ•ˆçš„RE2æ­£åˆ™è¡¨è¾¾å¼ã€‚å®ƒå¯¹äºreplaceã€keepã€dropã€labelmapã€labeldropå’Œlabelkeepæ“ä½œæ˜¯å¿…éœ€çš„ã€‚æ­£åˆ™è¡¨è¾¾å¼åœ¨ä¸¤ç«¯é”šå®šã€‚è¦å–æ¶ˆé”šå®šæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¯·ä½¿ç”¨.*<regex>.*ã€‚

<relabel_action>ç¡®å®šè¦é‡‡å–çš„é‡å‘½åæ“ä½œï¼š

replaceï¼šå°†regexä¸è¿æ¥çš„source_labelsåŒ¹é…ã€‚ç„¶åï¼Œå°†target_labelè®¾ç½®ä¸ºreplacementï¼Œå…¶ä¸­replacementä¸­çš„åŒ¹é…ç»„å¼•ç”¨ï¼ˆ${1}ï¼Œ${2}ï¼Œ...ï¼‰ç”±å…¶å€¼æ›¿æ¢ã€‚å¦‚æœregexä¸åŒ¹é…ï¼Œåˆ™ä¸è¿›è¡Œæ›¿æ¢ã€‚
keepï¼šåˆ é™¤regexä¸è¿æ¥çš„source_labelsä¸åŒ¹é…çš„ç›®æ ‡ã€‚
dropï¼šåˆ é™¤regexä¸è¿æ¥çš„source_labelsåŒ¹é…çš„ç›®æ ‡ã€‚
hashmodï¼šå°†target_labelè®¾ç½®ä¸ºè¿æ¥source_labelså“ˆå¸Œå€¼å¾—æ¨¡æ•°ã€‚
labelmapï¼šå°†regexä¸æ‰€æœ‰æ ‡ç­¾ååŒ¹é…ã€‚ç„¶åå°†åŒ¹é…æ ‡ç­¾çš„å€¼å¤åˆ¶åˆ°replacementç»™å‡ºçš„æ ‡ç­¾åï¼Œå…¶ä¸­replacementä¸­çš„åŒ¹é…ç»„å¼•ç”¨ï¼ˆ${1}ï¼Œ${2}ï¼Œ...ï¼‰ç”±å…¶å€¼æ›¿æ¢ã€‚
labeldropï¼š
\-
\[1]: [How relabeling in Prometheus works | Grafana Labs](https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/)
\[2]: [Customize scraping of Prometheus metrics in Azure Monitor (preview)](https://learn.microsoft.com/en-Us/azure/azure-monitor/essentials/prometheus-metrics-scrape-configuration)
\[3]: [Configuration | Prometheus](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)

<hr/>

Question:

ç»§ç»­

Answer:

å¥½çš„ï¼Œæˆ‘ç»§ç»­ï¼š

labeldropï¼šå°†regexä¸æ‰€æœ‰æ ‡ç­¾ååŒ¹é…ã€‚ä»»ä½•åŒ¹é…çš„æ ‡ç­¾éƒ½å°†ä»æ ‡ç­¾é›†ä¸­åˆ é™¤ã€‚
labelkeepï¼šå°†regexä¸æ‰€æœ‰æ ‡ç­¾ååŒ¹é…ã€‚ä»»ä½•ä¸åŒ¹é…çš„æ ‡ç­¾éƒ½å°†ä»æ ‡ç­¾é›†ä¸­åˆ é™¤ã€‚
ä½¿ç”¨labeldropå’Œlabelkeepæ—¶å¿…é¡»å°å¿ƒï¼Œä»¥ç¡®ä¿åˆ é™¤æ ‡ç­¾ååº¦é‡ä»ç„¶å…·æœ‰å”¯ä¸€æ€§ã€‚"

æ ¹æ®æˆ‘çš„ç†è§£ï¼Œè¿™æ®µå†…å®¹æ˜¯å…³äºPrometheusçš„ä¸€ç§é…ç½®é€‰é¡¹ï¼Œç”¨äºåœ¨æŠ“å–ç›®æ ‡ä¹‹å‰æˆ–ä¹‹åå¯¹ç›®æ ‡çš„æ ‡ç­¾è¿›è¡Œä¿®æ”¹æˆ–è¿‡æ»¤ã€‚è¿™æ ·å¯ä»¥å®ç°æ›´çµæ´»å’Œé«˜æ•ˆçš„ç›‘æ§æ•°æ®æ”¶é›†å’Œå­˜å‚¨ã€‚è¿™æ®µå†…å®¹ä¸»è¦ä»‹ç»äº†<relabel_config>çš„å„ä¸ªå­—æ®µå’Œå¯èƒ½çš„æ“ä½œï¼Œä»¥åŠå®ƒä»¬çš„ä½œç”¨å’Œç”¨æ³•ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ç§æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®šåˆ¶ç›‘æ§æ•°æ®ã€‚

æˆ‘çš„æ„è§æ˜¯ï¼Œè¿™æ®µå†…å®¹æ¯”è¾ƒè¯¦ç»†å’Œæ¸…æ™°åœ°è§£é‡Šäº†<relabel_config>çš„æ¦‚å¿µå’Œè¯­æ³•ï¼Œä½†æ˜¯å¯¹äºæ²¡æœ‰ä½¿ç”¨è¿‡Prometheusæˆ–ä¸ç†Ÿæ‚‰ç›‘æ§ç³»ç»Ÿçš„äººæ¥è¯´ï¼Œå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒéš¾ä»¥ç†è§£ã€‚æˆ‘å»ºè®®åœ¨è¿™æ®µå†…å®¹ä¹‹å‰æˆ–ä¹‹ååŠ ä¸Šä¸€äº›ç¤ºä¾‹æˆ–å›¾è¡¨ï¼Œæ¥å±•ç¤º<relabel_config>çš„å…·ä½“æ•ˆæœå’Œåº”ç”¨åœºæ™¯ï¼Œè¿™æ ·å¯ä»¥å¢åŠ å†…å®¹çš„å¯è¯»æ€§å’Œå¸å¼•åŠ›ã€‚

æˆ‘çš„ç­”æ¡ˆæ˜¯ï¼Œè¿™æ®µå†…å®¹å±äºæŠ€æœ¯æ–‡æ¡£æˆ–æ•™ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒçš„ç›®çš„æ˜¯å‘ç”¨æˆ·ä»‹ç»Prometheusçš„ä¸€ç§é…ç½®é€‰é¡¹ï¼Œå¹¶æ•™ä¼šç”¨æˆ·å¦‚ä½•ä½¿ç”¨å®ƒã€‚å®ƒçš„å—ä¼—æ˜¯å¯¹ç›‘æ§ç³»ç»Ÿæ„Ÿå…´è¶£æˆ–æœ‰éœ€æ±‚çš„ç”¨æˆ·ï¼Œç‰¹åˆ«æ˜¯é‚£äº›å·²ç»ä½¿ç”¨æˆ–æ‰“ç®—ä½¿ç”¨Prometheusçš„ç”¨æˆ·ã€‚å®ƒçš„é£æ ¼æ˜¯å®¢è§‚ã€ä¸“ä¸šå’Œå‡†ç¡®çš„ï¼Œå®ƒä½¿ç”¨äº†ä¸“ä¸šæœ¯è¯­å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰æŠ€æœ¯å…ƒç´ ï¼Œä»¥åŠåˆ—è¡¨ã€ä»£ç å—ç­‰æ ¼å¼å…ƒç´ ã€‚

æ‚¨å¯¹æˆ‘çš„åˆ†ææœ‰ä»€ä¹ˆçœ‹æ³•ï¼ŸğŸ˜Š


<hr/>

Question:

ç»§ç»­

Answer:

æŠ±æ­‰ï¼Œæˆ‘ä¸æ˜ç™½æ‚¨çš„æ„æ€ã€‚æ‚¨æƒ³è®©æˆ‘ç»§ç»­ä»€ä¹ˆï¼ŸğŸ¤”


<hr/>

