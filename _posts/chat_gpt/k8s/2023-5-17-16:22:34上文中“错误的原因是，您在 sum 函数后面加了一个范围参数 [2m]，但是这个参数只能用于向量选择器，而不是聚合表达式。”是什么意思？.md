---
layout: post
categories: k8s
---
Question:

Reply in Chinese (Simplified).
The following is a search input in a search engine, giving useful content or solutions and as much information as you can related to it, use markdown syntax to make your answer more readable, such as code blocks, bold, list:
rate(sum(container_cpu_usage_seconds_total{job=cadvisor, pod=~otel-collector.*, cluster=$cluster})by (pod)[2m]) bad_data: invalid parameter query: 1:126: parse error: ranges only allowed for vector selectors

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æ‚¨çš„æœç´¢è¾“å…¥æ˜¯ä¸€ä¸ªç”¨äºè·å–å®¹å™¨ CPU ä½¿ç”¨ç‡çš„ Prometheus æŸ¥è¯¢è¯­å¥ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªè¯­æ³•é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œã€‚<sup>1</sup> <sup>2</sup> <sup>3</sup>

é”™è¯¯çš„åŸå› æ˜¯ï¼Œæ‚¨åœ¨ `sum` å‡½æ•°åé¢åŠ äº†ä¸€ä¸ªèŒƒå›´å‚æ•° `[2m]`ï¼Œä½†æ˜¯è¿™ä¸ªå‚æ•°åªèƒ½ç”¨äºå‘é‡é€‰æ‹©å™¨ï¼Œè€Œä¸æ˜¯èšåˆè¡¨è¾¾å¼ã€‚<sup>1</sup>

è¦ä¿®å¤è¿™ä¸ªé”™è¯¯ï¼Œæ‚¨å¯ä»¥æŠŠèŒƒå›´å‚æ•°ç§»åˆ° `container_cpu_usage_seconds_total` åé¢ï¼Œæˆ–è€…å»æ‰å®ƒã€‚ä¾‹å¦‚ï¼š

```
rate(sum(container_cpu_usage_seconds_total{job=cadvisor, pod=~otel-collector.*, cluster=$cluster})by (pod))
```

æˆ–è€…

```
rate(sum(container_cpu_usage_seconds_total{job=cadvisor, pod=~otel-collector.*, cluster=$cluster}[2m])by (pod))
```

è¿™æ ·å°±å¯ä»¥å¾—åˆ°æ¯ä¸ª pod çš„ CPU ä½¿ç”¨ç‡çš„é€Ÿç‡äº†ã€‚

æ‚¨å¯ä»¥å‚è€ƒ Prometheus çš„æ–‡æ¡£[^4^æ¥äº†è§£æ›´å¤šå…³äºæŸ¥è¯¢è¯­è¨€çš„è¯­æ³•å’ŒåŠŸèƒ½ã€‚

å¸Œæœ›è¿™å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚ğŸ˜Š

\-
\[1]: [How to visualize current CPU usage of a pod with Grafana](https://serverfault.com/questions/984571/how-to-visualize-current-cpu-usage-of-a-pod-with-grafana)
\[2]: [A Deep Dive into Kubernetes Metrics â€” Part 3 Container ... - Medium](https://blog.freshtracks.io/a-deep-dive-into-kubernetes-metrics-part-3-container-resource-metrics-361c5ee46e66)
\[3]: [Difference between metrics results node node_namespace_pod_container ...](https://github.com/prometheus-operator/kube-prometheus/discussions/910)

<hr/>

Question:

```
rate(sum(container_cpu_usage_seconds_total{job=cadvisor, pod=~otel-collector.*, cluster=$cluster}[2m])by (pod))
```
bad_data: invalid parameter "query": 1:48: parse error: unexpected identifier "cadvisor" in label matching, expected string

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æ‚¨çš„æŸ¥è¯¢è¯­å¥åˆå‡ºç°äº†ä¸€ä¸ªè¯­æ³•é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œã€‚<sup>1</sup> <sup>2</sup> <sup>3</sup>

é”™è¯¯çš„åŸå› æ˜¯ï¼Œæ‚¨åœ¨æ ‡ç­¾åŒ¹é…ä¸­ä½¿ç”¨äº†ä¸€ä¸ªæ ‡è¯†ç¬¦ `cadvisor`ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚<sup>1</sup>

è¦ä¿®å¤è¿™ä¸ªé”™è¯¯ï¼Œæ‚¨å¯ä»¥æŠŠ `cadvisor` ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š

```
rate(sum(container_cpu_usage_seconds_total{job="cadvisor", pod=~otel-collector.*, cluster=$cluster}[2m])by (pod))
```

è¿™æ ·å°±å¯ä»¥æ­£ç¡®åœ°åŒ¹é…æ ‡ç­¾äº†ã€‚

è¯·é—®æ‚¨æ˜¯åœ¨å“ªé‡Œè¿è¡Œè¿™ä¸ªæŸ¥è¯¢è¯­å¥çš„ï¼Ÿæ˜¯åœ¨ Prometheus çš„ web ç•Œé¢ï¼Œè¿˜æ˜¯åœ¨ Grafana æˆ–å…¶ä»–å·¥å…·ä¸­ï¼Ÿä¸åŒçš„å·¥å…·å¯èƒ½æœ‰ä¸åŒçš„è¯­æ³•è¦æ±‚ã€‚

\-
\[1]: ['Race condition' and 'failed to fetch hugetlb info' errors in ... - GitHub](https://github.com/google/cadvisor/issues/3011)
\[2]: [vmagent can't scrape metrics with default k8s resources and ... - GitHub](https://github.com/VictoriaMetrics/VictoriaMetrics/issues/1365)
\[3]: [Observed "Error on ingesting out-of-order samples ... - GitHub](https://github.com/prometheus/prometheus/issues/10456)

<hr/>

Question:

```
rate(sum(container_cpu_usage_seconds_total{job="cadvisor", pod=~"otel-collector.*", cluster="$cluster"}[2m])by (pod))
```
bad_data: invalid parameter "query": 1:10: parse error: expected type instant vector in aggregation expression, got range vector

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æ‚¨çš„æŸ¥è¯¢è¯­å¥è¿˜æœ‰ä¸€ä¸ªè¯­æ³•é”™è¯¯ï¼Œå¯¼è‡´æ— æ³•æ‰§è¡Œã€‚<sup>1</sup> <sup>2</sup> <sup>3</sup>

é”™è¯¯çš„åŸå› æ˜¯ï¼Œæ‚¨åœ¨ `sum` å‡½æ•°ä¸­ä½¿ç”¨äº†ä¸€ä¸ªèŒƒå›´å‘é‡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç¬æ—¶å‘é‡ã€‚<sup>1</sup>

è¦ä¿®å¤è¿™ä¸ªé”™è¯¯ï¼Œæ‚¨å¯ä»¥æŠŠ `rate` å‡½æ•°ç§»åˆ° `sum` å‡½æ•°å¤–é¢ï¼Œä¾‹å¦‚ï¼š

```
sum(rate(container_cpu_usage_seconds_total{job="cadvisor", pod=~"otel-collector.*", cluster="$cluster"}[2m]))by (pod)
```

è¿™æ ·å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªç¬æ—¶å‘é‡ï¼Œç„¶åç”¨ `sum` å‡½æ•°è¿›è¡Œèšåˆäº†ã€‚

è¯·é—®æ‚¨æ˜¯æƒ³è·å–æ¯ä¸ª pod çš„ CPU ä½¿ç”¨ç‡çš„å¹³å‡å€¼å—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `avg_over_time` å‡½æ•°æ¥è®¡ç®—ã€‚<sup>2</sup>

\-
\[1]: [Querying basics | Prometheus](https://prometheus.io/docs/prometheus/latest/querying/basics/)
\[2]: [æˆåŠŸè§£å†³expected type range vector in call to function â€œavg_over_timeâ€œ, got ...](https://blog.csdn.net/HYZX_9987/article/details/106094581)
\[3]: [monitoring - Smoothing Grafana graph - Server Fault](https://serverfault.com/questions/986800/smoothing-grafana-graph)

<hr/>

Question:

æˆ‘æ˜¯æƒ³è·å–PODçš„ CPUä½¿ç”¨æƒ…å†µ

Answer:

æ‚¨å¥½ï¼Œè¿™æ˜¯å¿…åº”ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢è¯­å¥æ¥è·å–æ¯ä¸ª pod çš„ CPU ä½¿ç”¨æƒ…å†µï¼š

```
sum(rate(container_cpu_usage_seconds_total{job="cadvisor", pod=~"otel-collector.*", cluster="$cluster"}[2m]))by (pod)
```

è¿™ä¸ªæŸ¥è¯¢è¯­å¥ä¼šè¿”å›æ¯ä¸ª pod çš„ CPU ä½¿ç”¨ç‡çš„é€Ÿç‡ï¼Œä¹Ÿå°±æ˜¯ CPU ä½¿ç”¨æ—¶é—´åœ¨ä¸€å®šæ—¶é—´é—´éš”å†…çš„å˜åŒ–ç‡ã€‚

å¦‚æœæ‚¨æƒ³è·å–æ¯ä¸ª pod çš„ CPU ä½¿ç”¨ç‡çš„ç™¾åˆ†æ¯”ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢è¯­å¥ï¼š

```
sum(rate(container_cpu_usage_seconds_total{job="cadvisor", pod=~"otel-collector.*", cluster="$cluster"}[2m]))by (pod) / sum(machine_cpu_cores)by (pod) * 100
```

è¿™ä¸ªæŸ¥è¯¢è¯­å¥ä¼šè¿”å›æ¯ä¸ª pod çš„ CPU ä½¿ç”¨ç‡å æ€» CPU æ ¸æ•°çš„ç™¾åˆ†æ¯”ã€‚[^2^å¸Œæœ›è¿™å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚ğŸ˜Š


<hr/>

